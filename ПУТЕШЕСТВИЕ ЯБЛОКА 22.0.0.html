<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Путешествие Яблока (REBIRTH) - Сезон 22: Яблочный Разлом</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }
        
        /* === SEASON 22 START === */
        body {
            background: #0a0a1a;
            color: white;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 30%, rgba(106, 13, 173, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(13, 102, 173, 0.2) 0%, transparent 50%),
                radial-gradient(circle at 40% 80%, rgba(173, 13, 165, 0.25) 0%, transparent 50%),
                linear-gradient(180deg, #0a0a1a 0%, #1a0a2a 100%);
            z-index: -3;
        }

        .cosmic-fissure {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2;
            opacity: 0.7;
            background-image: 
                linear-gradient(90deg, transparent 49%, rgba(138, 43, 226, 0.3) 50%, transparent 51%),
                linear-gradient(transparent 49%, rgba(138, 43, 226, 0.3) 50%, transparent 51%);
            background-size: 50px 50px, 50px 50px;
            animation: fissurePulse 4s infinite alternate;
        }

        @keyframes fissurePulse {
            0% { opacity: 0.5; }
            100% { opacity: 0.8; }
        }

        .floating-fragments {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            pointer-events: none;
        }

        .apple-fragment {
            position: absolute;
            width: 20px;
            height: 20px;
            background: radial-gradient(circle, rgba(106, 13, 173, 0.7), rgba(13, 102, 173, 0.5));
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(138, 43, 226, 0.5);
            opacity: 0;
        }

        .glitch-effect {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            opacity: 0.05;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100"><rect width="100" height="100" fill="none" stroke="%238A2BE2" stroke-width="2" stroke-dasharray="5,5"/></svg>');
            animation: glitch 0.1s infinite;
        }

        @keyframes glitch {
            0% { transform: translateX(0); }
            25% { transform: translateX(-2px); }
            50% { transform: translateX(0); }
            75% { transform: translateX(2px); }
            100% { transform: translateX(0); }
        }

        .anomaly-case-icon {
            background-image: url('https://i.ibb.co/0jQz8ZR/anomaly-case.png');
            background-color: #8A2BE2;
            border-radius: 10px;
            border: 2px solid #00ffff;
        }

        .rift-case-icon {
            background-image: url('https://i.ibb.co/4ZBgCqK/rift-case.png');
            background-color: #4B0082;
            border-radius: 10px;
            border: 2px solid #ff00ff;
        }

        .rarity-fracture { 
            color: #8A2BE2;
            text-shadow: 0 0 10px rgba(138, 43, 226, 0.7);
        }

        .border-fracture { 
            border-color: #8A2BE2;
            border-image: linear-gradient(45deg, #8A2BE2, #00ffff) 1;
        }

        .background-fracture { 
            background: radial-gradient(circle, #8A2BE2, #4B0082);
            animation: fracturePulse 2s infinite alternate;
        }

        @keyframes fracturePulse {
            0% { transform: scale(1); opacity: 0.8; }
            100% { transform: scale(1.05); opacity: 1; }
        }

        .new-year-timer {
            grid-column: 1 / -1;
            background: rgba(255, 0, 0, 0.2);
            border: 2px solid #ff0000;
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            margin-top: 20px;
            animation: pulse 2s infinite;
        }

        .timer-title {
            color: #ffcc00;
            font-size: 20px;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .timer-countdown {
            font-size: 24px;
            font-weight: bold;
            color: #ff0000;
            font-family: monospace;
        }

        .fracture-energy-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .fracture-energy-icon {
            font-size: 24px;
            color: #8A2BE2;
            text-shadow: 0 0 10px rgba(138, 43, 226, 0.7);
        }

        .fracture-energy-count {
            font-size: 22px;
            font-weight: bold;
            color: #8A2BE2;
            text-shadow: 0 0 10px rgba(138, 43, 226, 0.5);
        }

        .reality-rift-event {
            border-color: #8A2BE2 !important;
            background: rgba(138, 43, 226, 0.1);
        }

        .reality-rift-event:hover {
            box-shadow: 0 20px 40px rgba(138, 43, 226, 0.5);
        }

        .champion-challenge-event {
            border-color: #FFD700 !important;
            background: rgba(255, 215, 0, 0.15);
        }

        .champion-challenge-event:hover {
            box-shadow: 0 20px 40px rgba(255, 215, 0, 0.6);
        }

        .modifier-badge {
            display: inline-block;
            background: rgba(255, 0, 0, 0.3);
            color: #ffcc00;
            padding: 5px 10px;
            border-radius: 10px;
            margin: 5px;
            font-size: 14px;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .cosmic-fissure {
                background-size: 30px 30px, 30px 30px;
            }
            
            .apple-fragment {
                width: 15px;
                height: 15px;
            }
        }
        /* === SEASON 22 END === */

        .container {
            display: flex;
            min-height: 100vh;
            position: relative;
        }

        .game-header {
            position: fixed;
            top: 0;
            left: 0;
            z-index: 100;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            background: rgba(20, 20, 50, 0.9);
            border-radius: 0 0 15px 0;
            border-right: 2px solid #ff6b00;
            border-bottom: 2px solid #ff6b00;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        }

        .balance-container, .upgrade-container, .trophies-container, .crystals-container, .tickets-container, .fracture-energy-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .balance, .upgrade-level, .trophies-count, .crystals-count, .tickets-count, .fracture-energy-count {
            font-size: 22px;
            font-weight: bold;
            color: #ffcc00;
            text-shadow: 0 0 10px rgba(255, 204, 0, 0.5);
        }

        .currency-icon, .upgrade-icon, .trophy-icon, .crystal-icon, .ticket-icon, .fracture-energy-icon {
            font-size: 24px;
            color: #ffcc00;
        }

        .f-bucks-icon {
            width: 24px;
            height: 24px;
            background-image: url('https://i.ibb.co/LXP8Z3Nw/f-bucks.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }

        .apple-pass-icon {
            position: fixed;
            bottom: 30px;
            left: 30px;
            width: 80px;
            height: 80px;
            background: linear-gradient(45deg, #8A2BE2, #00ffff);
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 99;
            box-shadow: 0 8px 20px rgba(138, 43, 226, 0.7);
            transition: all 0.3s;
            border: 3px solid #ffcc00;
        }

        .apple-pass-icon:hover {
            transform: scale(1.1);
        }

        .apple-pass-icon i {
            font-size: 36px;
            color: white;
        }

        .apple-pass-points {
            color: white;
            font-weight: bold;
            font-size: 14px;
            margin-top: 5px;
        }

        .fullscreen-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            font-size: 18px;
            background: linear-gradient(45deg, #8A2BE2, #00ffff);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 5px 15px rgba(138, 43, 226, 0.5);
            z-index: 101;
        }

        .fullscreen-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 25px rgba(138, 43, 226, 0.7);
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ffcc00;
            color: #000;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            z-index: 10;
        }

        .pulse-btn {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 204, 0, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 204, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 204, 0, 0); }
        }

        .content {
            flex: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .main-menu {
            width: 100%;
            min-height: 90vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding-bottom: 100px;
            position: relative;
            z-index: 2;
        }

        .game-title {
            font-size: 36px;
            margin-bottom: 30px;
            background: linear-gradient(45deg, #8A2BE2, #00ffff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 20px rgba(138, 43, 226, 0.5);
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .season-badge {
            background: linear-gradient(45deg, #8A2BE2, #00ffff);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            text-transform: uppercase;
            animation: seasonGlow 3s infinite alternate;
        }

        @keyframes seasonGlow {
            0% { box-shadow: 0 0 10px rgba(138, 43, 226, 0.5); }
            100% { box-shadow: 0 0 20px rgba(0, 255, 255, 0.7); }
        }

        .character-lobby-icon {
            font-size: 200px;
            cursor: pointer;
            margin: 30px 0;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 300px;
            height: 300px;
            position: relative;
        }

        .character-lobby-icon:hover {
            transform: scale(1.05);
        }

        .character-lobby-icon img {
            max-width: 250px;
            max-height: 250px;
            width: auto;
            height: auto;
            object-fit: contain;
        }

        .menu-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
            justify-content: center;
            position: relative;
        }

        .menu-btn {
            padding: 12px 25px;
            font-size: 18px;
            background: linear-gradient(45deg, #8A2BE2, #00ffff);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 5px 15px rgba(138, 43, 226, 0.5);
            position: relative;
        }

        .menu-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(138, 43, 226, 0.7);
        }

        .play-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            padding: 18px 50px;
            font-size: 24px;
            background: linear-gradient(45deg, #8A2BE2, #00ffff);
            color: white;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 10px 25px rgba(138, 43, 226, 0.5);
            z-index: 100;
        }

        .events-btn {
            position: fixed;
            bottom: 30px;
            right: 200px;
            padding: 18px 50px;
            font-size: 24px;
            background: linear-gradient(45deg, #0088ff, #00aaff);
            color: white;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 10px 25px rgba(0, 136, 255, 0.5);
            z-index: 100;
        }

        .play-btn:hover, .events-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 15px 30px rgba(138, 43, 226, 0.7);
        }

        .events-btn:hover {
            box-shadow: 0 15px 30px rgba(0, 136, 255, 0.7);
        }

        .events-section {
            display: none;
            width: 100%;
            height: 90vh;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto;
        }

        .events-section.active {
            display: flex;
        }

        .events-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 30px;
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
        }

        .event-card {
            background: rgba(30, 30, 60, 0.9);
            border-radius: 20px;
            padding: 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: all 0.3s;
            border: 3px solid #ff6b00;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            position: relative;
            overflow: hidden;
        }

        .event-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 20px 40px rgba(255, 107, 0, 0.5);
        }

        .event-card.premium {
            border-color: #00aaff;
            box-shadow: 0 10px 30px rgba(0, 136, 255, 0.5);
        }

        .event-card.premium:hover {
            box-shadow: 0 20px 40px rgba(0, 136, 255, 0.7);
        }

        .event-icon {
            font-size: 80px;
            margin-bottom: 20px;
            color: #ffcc00;
        }

        .event-title {
            font-size: 28px;
            margin-bottom: 15px;
            color: #fff;
            text-align: center;
        }

        .event-description {
            text-align: center;
            color: #aaa;
            margin-bottom: 20px;
            line-height: 1.5;
            font-size: 16px;
        }

        .event-reward {
            font-size: 20px;
            color: #ffcc00;
            margin-bottom: 25px;
            text-align: center;
            font-weight: bold;
        }

        .event-requirements {
            font-size: 16px;
            color: #ff6b6b;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
        }

        .event-play-btn {
            padding: 15px 40px;
            background: linear-gradient(45deg, #8A2BE2, #00ffff);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            width: 100%;
        }

        .event-play-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 20px rgba(138, 43, 226, 0.5);
        }

        .event-play-btn:disabled {
            background: #555;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .event-play-btn.premium {
            background: linear-gradient(45deg, #0088ff, #00aaff);
        }

        .event-play-btn.premium:hover {
            box-shadow: 0 8px 20px rgba(0, 136, 255, 0.5);
        }

        .event-play-btn.champion {
            background: linear-gradient(45deg, #FFD700, #FFA500);
        }

        .event-play-btn.champion:hover {
            box-shadow: 0 8px 20px rgba(255, 215, 0, 0.6);
        }

        .survival-game {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
            z-index: 1000;
            overflow: hidden;
        }

        .survival-game.active {
            display: block;
        }

        .survival-header {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10;
        }

        .survival-timer {
            font-size: 32px;
            font-weight: bold;
            color: #ffcc00;
            text-shadow: 0 0 10px rgba(255, 204, 0, 0.5);
        }

        .survival-health {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .health-bar {
            width: 300px;
            height: 30px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 15px;
            overflow: hidden;
            border: 2px solid #ff6b00;
        }

        .health-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff0000, #00ff00);
            border-radius: 15px;
            width: 100%;
            transition: width 0.3s;
        }

        .health-text {
            font-size: 20px;
            font-weight: bold;
            color: #fff;
        }

        .survival-game-area {
            width: 100%;
            height: 100%;
            position: relative;
            overflow: hidden;
        }

        .survival-player {
            position: absolute;
            width: 60px;
            height: 60px;
            background: radial-gradient(circle, #4CAF50, #2E7D32);
            border-radius: 50%;
            box-shadow: 0 0 20px rgba(76, 175, 80, 0.5);
            transition: transform 0.1s;
            z-index: 5;
        }

        .survival-enemy {
            position: absolute;
            width: 70px;
            height: 70px;
            background: radial-gradient(circle, #ff0000, #990000);
            border-radius: 50%;
            box-shadow: 0 0 25px rgba(255, 0, 0, 0.7);
            z-index: 5;
        }

        .mini-apple {
            position: absolute;
            width: 40px;
            height: 40px;
            background: radial-gradient(circle, #ffcc00, #ff9900);
            border-radius: 50%;
            box-shadow: 0 0 15px rgba(255, 204, 0, 0.7);
            z-index: 4;
        }

        .bullet {
            position: absolute;
            width: 20px;
            height: 20px;
            background: #ff4444;
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(255, 68, 68, 0.8);
            z-index: 3;
        }

        .joystick-container {
            position: absolute;
            bottom: 120px;
            left: 120px;
            width: 150px;
            height: 150px;
            z-index: 10;
        }

        .joystick-base {
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border: 3px solid rgba(255, 255, 255, 0.3);
            position: absolute;
        }

        .joystick-handle {
            width: 60px;
            height: 60px;
            background: linear-gradient(45deg, #8A2BE2, #00ffff);
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            cursor: move;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        }

        .exit-survival-btn {
            position: absolute;
            bottom: 30px;
            right: 30px;
            padding: 15px 40px;
            font-size: 20px;
            background: linear-gradient(45deg, #8A2BE2, #00ffff);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            z-index: 10;
        }

        .exit-survival-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 25px rgba(138, 43, 226, 0.7);
        }

        .characters-section {
            display: none;
            width: 100%;
            height: 90vh;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto;
        }

        .characters-section.active {
            display: flex;
        }

        .character-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .character-tab {
            padding: 10px 20px;
            background: rgba(30, 30, 60, 0.8);
            border: none;
            border-radius: 10px;
            color: white;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .character-tab.active {
            background: linear-gradient(45deg, #8A2BE2, #00ffff);
            box-shadow: 0 5px 15px rgba(138, 43, 226, 0.5);
        }

        .character-tab:hover:not(.active) {
            background: rgba(50, 50, 80, 0.8);
        }

        .section-title {
            font-size: 28px;
            margin-bottom: 20px;
            color: #8A2BE2;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 2px solid #8A2BE2;
            padding-bottom: 10px;
        }

        .character-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .character-category {
            grid-column: 1 / -1;
            font-size: 20px;
            color: #ffcc00;
            margin: 20px 0 10px;
            text-align: left;
            border-bottom: 1px solid #ffcc00;
            padding-bottom: 5px;
        }

        .character-item {
            background: rgba(30, 30, 60, 0.8);
            border-radius: 12px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 3px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .character-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(138, 43, 226, 0.5);
        }

        .character-item.unlocked:hover {
            border-color: #ffcc00;
        }

        .character-item.locked {
            filter: grayscale(100%);
            opacity: 0.7;
            cursor: not-allowed;
        }

        .character-item.selected {
            border-color: #8A2BE2;
            box-shadow: 0 0 20px rgba(138, 43, 226, 0.7);
        }

        .character-icon {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            margin-bottom: 10px;
            background-color: rgba(0, 0, 0, 0.3);
            border: 3px solid;
            overflow: hidden;
        }

        .character-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .character-name {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 8px;
            color: white;
            text-align: center;
        }

        .character-rarity {
            font-size: 14px;
            padding: 4px 10px;
            border-radius: 10px;
            display: inline-block;
            text-align: center;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .locked-text {
            color: #ff6b6b;
            font-size: 12px;
            margin-top: 8px;
            font-weight: bold;
            text-align: center;
            background: rgba(0, 0, 0, 0.3);
            padding: 5px;
            border-radius: 6px;
            width: 100%;
        }

        .rarity-common { color: #ffffff; }
        .rarity-rare { color: #4CAF50; }
        .rarity-super-rare { color: #2196F3; }
        .rarity-epic { color: #9C27B0; }
        .rarity-mythic { color: #F44336; }
        .rarity-legendary { color: #FFC107; }
        .rarity-monochrome { 
            background: linear-gradient(45deg, #ff0000, #ff9900, #ffff00, #00ff00, #00ffff, #0000ff, #9900ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .rarity-trophy {
            color: #C0C0C0;
            background: linear-gradient(45deg, #ffffff, #c0c0c0, #a0a0a0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .rarity-exclusive {
            background: linear-gradient(45deg, #ff0000, #0000ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .border-common { border-color: #ffffff; }
        .border-rare { border-color: #4CAF50; }
        .border-super-rare { border-color: #2196F3; }
        .border-epic { border-color: #9C27B0; }
        .border-mythic { border-color: #F44336; }
        .border-legendary { border-color: #FFC107; }
        .border-monochrome { border-image: linear-gradient(45deg, #ff0000, #ff9900, #ffff00, #00ff00, #00ffff, #0000ff, #9900ff) 1; }
        .border-trophy { border-color: #C0C0C0; }
        .border-exclusive { border-image: linear-gradient(45deg, #ff0000, #0000ff) 1; }

        .shop-section {
            display: none;
            width: 100%;
            height: 90vh;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto;
        }

        .shop-section.active {
            display: flex;
        }

        .shop-items {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .shop-item {
            background: rgba(30, 30, 60, 0.9);
            border-radius: 15px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: all 0.3s;
            border: 3px solid transparent;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
        }

        .shop-item:hover {
            transform: translateY(-8px);
            border-color: #8A2BE2;
            box-shadow: 0 12px 25px rgba(138, 43, 226, 0.5);
        }

        .shop-item-icon {
            width: 100px;
            height: 100px;
            margin-bottom: 20px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }

        .apple-case-icon {
            background-image: url('https://i.ibb.co/f7nMj9c/Picsart-25-12-09-23-02-46-736.png');
        }

        .new-year-case-icon {
            background-image: url('https://i.ibb.co/2cVjYhR/new-year-case.png');
            background-color: #ff0000;
            border-radius: 10px;
        }

        .upgrade-icon-shop {
            color: #4CAF50;
            font-size: 60px;
        }

        .shop-item-title {
            font-size: 24px;
            margin-bottom: 12px;
            color: #fff;
            text-align: center;
        }

        .shop-item-description {
            text-align: center;
            color: #aaa;
            margin-bottom: 20px;
            line-height: 1.4;
            font-size: 16px;
        }

        .shop-item-price {
            font-size: 22px;
            color: #ffcc00;
            margin-bottom: 20px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
        }

        .buy-btn {
            padding: 12px 30px;
            background: linear-gradient(45deg, #8A2BE2, #00ffff);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            width: 100%;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .buy-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 20px rgba(138, 43, 226, 0.5);
        }

        .buy-btn:disabled {
            background: #555;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .max-upgrade {
            color: #ff6b6b;
            font-weight: bold;
            margin-top: 12px;
            font-size: 18px;
            text-align: center;
        }

        .promo-section {
            grid-column: 1 / -1;
            margin-top: 20px;
        }

        .promo-input {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .promo-input input {
            flex: 1;
            padding: 12px;
            border-radius: 10px;
            border: 2px solid #8A2BE2;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
        }

        .promo-input button {
            padding: 12px 24px;
            background: linear-gradient(45deg, #8A2BE2, #00ffff);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
        }

        .back-btn {
            margin-top: 20px;
            padding: 12px 30px;
            background: linear-gradient(45deg, #8A2BE2, #00ffff);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            align-self: center;
        }

        .back-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 20px rgba(138, 43, 226, 0.5);
        }

        .case-opening {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, #0c2461 0%, #1a1a2e 100%);
            z-index: 1000;
        }

        .case-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }

        .case-title {
            font-size: 36px;
            color: #ffcc00;
            margin-bottom: 30px;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .case-count {
            position: absolute;
            bottom: 40px;
            left: 40px;
            font-size: 24px;
            color: #ffcc00;
            background: rgba(0, 0, 0, 0.8);
            padding: 12px 25px;
            border-radius: 12px;
            border: 2px solid #8A2BE2;
        }

        .apple-case {
            width: 400px;
            height: 400px;
            background-image: url('https://i.ibb.co/f7nMj9c/Picsart-25-12-09-23-02-46-736.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            transition: all 0.3s;
            box-shadow: 0 15px 40px rgba(255, 204, 0, 0.6);
            animation: float 3s ease-in-out infinite;
            overflow: hidden;
        }

        .apple-case:hover {
            transform: scale(1.05);
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        .case-lock {
            font-size: 100px;
            color: #fff;
            text-shadow: 0 0 25px rgba(0, 0, 0, 0.7);
        }

        .case-hint {
            position: absolute;
            top: -40px;
            color: #ff0000;
            font-size: 24px;
            font-weight: bold;
            white-space: nowrap;
            opacity: 0;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .case-shake {
            animation: shake 0.5s ease-in-out infinite;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0) rotate(0); }
            25% { transform: translateX(-12px) rotate(-5deg); }
            75% { transform: translateX(12px) rotate(5deg); }
        }

        .case-opening-animation {
            animation: openCase 1.5s forwards;
        }

        @keyframes openCase {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(0); opacity: 0; }
        }

        .case-rewards {
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 30px;
            animation: fadeIn 1s forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .reward-item {
            display: flex;
            align-items: center;
            gap: 25px;
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 15px;
            min-width: 350px;
            border: 2px solid #8A2BE2;
        }

        .reward-icon {
            font-size: 60px;
        }

        .reward-fbucks-icon {
            width: 60px;
            height: 60px;
            background-image: url('https://i.ibb.co/LXP8Z3Nw/f-bucks.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }

        .reward-text {
            font-size: 24px;
            color: #fff;
        }

        .reward-money {
            color: #ffcc00;
        }

        .reward-character {
            color: #ff6b8b;
        }

        .close-case-btn {
            margin-top: 40px;
            padding: 18px 50px;
            background: linear-gradient(45deg, #8A2BE2, #00ffff);
            color: white;
            border: none;
            border-radius: 15px;
            font-size: 22px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .close-case-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 25px rgba(138, 43, 226, 0.7);
        }

        .apple-catching-game {
            display: none;
            width: 100%;
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            background: linear-gradient(180deg, #0a0a1a 0%, #1a2a3a 100%);
            z-index: 1000;
            overflow: hidden;
        }

        .apple-catching-game.active {
            display: block;
        }

        .game-header-bar {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10;
        }

        .game-timer, .game-score {
            font-size: 32px;
            font-weight: bold;
            color: #ffcc00;
            text-shadow: 0 0 10px rgba(255, 204, 0, 0.5);
        }

        .game-target {
            position: absolute;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 24px;
            color: white;
            text-align: center;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 20px;
            border-radius: 10px;
            border: 2px solid #8A2BE2;
        }

        .apple {
            position: absolute;
            font-size: 60px;
            cursor: pointer;
            transition: transform 0.2s, opacity 0.2s;
            user-select: none;
        }

        .apple:hover {
            transform: scale(1.1);
        }

        .apple.caught {
            animation: caughtAnimation 0.5s forwards;
        }

        @keyframes caughtAnimation {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(0); opacity: 0; }
        }

        .game-end-screen {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 20;
        }

        .game-result {
            font-size: 48px;
            font-weight: bold;
            margin-bottom: 30px;
            text-transform: uppercase;
        }

        .game-won {
            color: #4CAF50;
        }

        .game-lost {
            color: #F44336;
        }

        .game-stats {
            font-size: 24px;
            margin-bottom: 30px;
            text-align: center;
        }

        .exit-game-btn {
            padding: 18px 50px;
            font-size: 24px;
            background: linear-gradient(45deg, #8A2BE2, #00ffff);
            color: white;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .exit-game-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 25px rgba(138, 43, 226, 0.7);
        }

        .trophy-road-section {
            display: none;
            width: 100%;
            height: 90vh;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto;
        }

        .trophy-road-section.active {
            display: flex;
        }

        .trophy-road-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
        }

        .trophy-road-progress {
            width: 100%;
            max-width: 800px;
            margin-bottom: 30px;
        }

        .trophy-road-bar {
            height: 30px;
            background: rgba(60, 60, 80, 0.5);
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 10px;
            border: 2px solid #8A2BE2;
        }

        .trophy-road-fill {
            height: 100%;
            background: linear-gradient(90deg, #8A2BE2, #00ffff);
            border-radius: 15px;
            width: 0%;
            transition: width 1s ease;
        }

        .trophy-road-text {
            display: flex;
            justify-content: space-between;
            font-size: 18px;
            color: #aaa;
        }

        .trophy-road-rewards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            width: 100%;
            max-width: 1000px;
        }

        .trophy-reward-item {
            background: rgba(30, 30, 60, 0.8);
            border-radius: 15px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: all 0.3s;
            border: 3px solid transparent;
            position: relative;
        }

        .trophy-reward-item.claimed {
            border-color: #4CAF50;
            background: rgba(30, 60, 30, 0.8);
        }

        .trophy-reward-item.available {
            border-color: #ffcc00;
            cursor: pointer;
            animation: pulse 2s infinite;
        }

        .trophy-reward-item.available:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(255, 204, 0, 0.5);
        }

        .trophy-reward-item.locked {
            filter: grayscale(80%);
            opacity: 0.7;
        }

        .reward-trophies {
            position: absolute;
            top: 10px;
            left: 10px;
            font-size: 20px;
            font-weight: bold;
            color: #ffcc00;
            background: rgba(0, 0, 0, 0.7);
            padding: 5px 10px;
            border-radius: 10px;
        }

        .reward-new-milestone {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 14px;
            font-weight: bold;
            color: #ff0000;
            background: rgba(0, 0, 0, 0.7);
            padding: 5px 10px;
            border-radius: 10px;
            text-transform: uppercase;
        }

        .reward-icon-trophy {
            width: 80px;
            height: 80px;
            margin: 20px 0;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }

        .mysterious-chest-icon {
            background-image: url('https://i.ibb.co/VXgrSKx/Picsart-25-12-09-23-02-22-635.png');
        }

        .money-icon-trophy {
            background-image: url('https://i.ibb.co/LXP8Z3Nw/f-bucks.png');
        }

        .crystal-icon-trophy {
            color: #00ffff;
            font-size: 60px;
        }

        .reward-name {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
        }

        .reward-amount {
            font-size: 18px;
            color: #ffcc00;
            font-weight: bold;
        }

        .mysterious-chest-opening {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, #2a0c3d 0%, #1a1a2e 100%);
            z-index: 1100;
        }

        .mysterious-chest-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }

        .mysterious-chest-title {
            font-size: 36px;
            color: #ffcc00;
            margin-bottom: 30px;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .mysterious-chest {
            width: 300px;
            height: 250px;
            background-image: url('https://i.ibb.co/VXgrSKx/Picsart-25-12-09-23-02-22-635.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            transition: all 0.3s;
            box-shadow: 0 15px 40px rgba(156, 39, 176, 0.7);
            overflow: hidden;
        }

        .mysterious-chest:hover {
            transform: scale(1.05);
        }

        .chest-crack {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }

        .chest-tap-counter {
            position: absolute;
            bottom: -40px;
            font-size: 20px;
            color: #ffcc00;
            font-weight: bold;
        }

        .chest-open-animation {
            animation: chestOpen 1s forwards;
        }

        @keyframes chestOpen {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(0); opacity: 0; }
        }

        .chest-rewards {
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 30px;
            animation: fadeIn 1s forwards;
        }

        .close-chest-btn {
            margin-top: 40px;
            padding: 18px 50px;
            background: linear-gradient(45deg, #8A2BE2, #00ffff);
            color: white;
            border: none;
            border-radius: 15px;
            font-size: 22px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .close-chest-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 25px rgba(138, 43, 226, 0.7);
        }

        .notification {
            position: fixed;
            top: 30px;
            right: 30px;
            padding: 20px 30px;
            background: rgba(30, 30, 60, 0.95);
            border-radius: 15px;
            border-left: 8px solid;
            z-index: 1001;
            transform: translateX(400px);
            transition: transform 0.5s;
            max-width: 400px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification-money {
            border-left-color: #ffcc00;
        }

        .notification-unlock {
            border-left-color: #4CAF50;
        }

        .notification-trophies {
            border-left-color: #ff6b00;
        }

        .notification-crystals {
            border-left-color: #00ffff;
        }

        .notification-tickets {
            border-left-color: #0088ff;
        }

        .notification-fracture {
            border-left-color: #8A2BE2;
        }

        .notification-title {
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 20px;
        }

        .notification-message {
            color: #aaa;
            font-size: 16px;
        }

        .apple-pass-section {
            display: none;
            width: 100%;
            height: 90vh;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto;
        }

        .apple-pass-section.active {
            display: flex;
        }

        .rank-rewards-section {
            display: none;
            width: 100%;
            height: 90vh;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto;
        }

        .rank-rewards-section.active {
            display: flex;
        }

        .apple-pass-season-title {
            font-size: 24px;
            margin-bottom: 20px;
            color: #8A2BE2;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 2px solid #8A2BE2;
            padding-bottom: 10px;
        }

        .apple-pass-rewards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
        }

        .apple-pass-reward-item {
            background: rgba(30, 30, 60, 0.8);
            border-radius: 15px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: all 0.3s;
            border: 3px solid transparent;
            position: relative;
        }

        .apple-pass-reward-item.claimed {
            border-color: #4CAF50;
            background: rgba(30, 60, 30, 0.8);
        }

        .apple-pass-reward-item.available {
            border-color: #ffcc00;
            cursor: pointer;
            animation: pulse 2s infinite;
        }

        .apple-pass-reward-item.available:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(255, 204, 0, 0.5);
        }

        .apple-pass-reward-item.locked {
            filter: grayscale(80%);
            opacity: 0.7;
        }

        .reward-apple-pass-points {
            position: absolute;
            top: 10px;
            left: 10px;
            font-size: 18px;
            font-weight: bold;
            color: #ffcc00;
            background: rgba(0, 0, 0, 0.7);
            padding: 5px 10px;
            border-radius: 10px;
        }

        .reward-icon-apple-pass {
            width: 60px;
            height: 60px;
            margin: 15px 0;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }

        .money-icon-apple-pass {
            background-image: url('https://i.ibb.co/LXP8Z3Nw/f-bucks.png');
        }

        .upgrade-icon-apple-pass {
            color: #4CAF50;
            font-size: 50px;
        }

        .crystal-icon-apple-pass {
            color: #00ffff;
            font-size: 50px;
        }

        .reward-name-apple-pass {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
        }

        .reward-amount-apple-pass {
            font-size: 16px;
            color: #ffcc00;
            font-weight: bold;
            text-align: center;
        }

        .character-reveal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1200;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .character-reveal-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }

        .character-reveal-background {
            width: 500px;
            height: 500px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            animation: pulseBackground 2s infinite;
        }

        .background-common { background: radial-gradient(circle, #ffffff, #aaaaaa); }
        .background-rare { background: radial-gradient(circle, #4CAF50, #1b5e20); }
        .background-super-rare { background: radial-gradient(circle, #2196F3, #0d47a1); }
        .background-epic { background: radial-gradient(circle, #9C27B0, #4a148c); }
        .background-mythic { background: radial-gradient(circle, #F44336, #b71c1c); }
        .background-legendary { background: radial-gradient(circle, #FFC107, #ff6f00); }
        .background-monochrome { 
            background: radial-gradient(circle, #ff0000, #ff9900, #ffff00, #00ff00, #00ffff, #0000ff, #9900ff);
            animation: rainbowBackground 3s infinite linear;
        }
        .background-trophy { background: radial-gradient(circle, #C0C0C0, #808080); }
        .background-exclusive { 
            background: radial-gradient(circle, #ff0000, #0000ff);
            animation: exclusiveBackground 3s infinite alternate;
        }

        @keyframes pulseBackground {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes rainbowBackground {
            0% { filter: hue-rotate(0deg); }
            100% { filter: hue-rotate(360deg); }
        }

        @keyframes exclusiveBackground {
            0% { background: radial-gradient(circle, #ff0000, #0000ff); }
            50% { background: radial-gradient(circle, #0000ff, #ff0000); }
            100% { background: radial-gradient(circle, #ff0000, #0000ff); }
        }

        .revealed-character {
            font-size: 150px;
            animation: characterReveal 1s ease-out;
        }

        @keyframes characterReveal {
            0% { transform: scale(0) rotate(-180deg); opacity: 0; }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }

        .character-reveal-name {
            font-size: 36px;
            font-weight: bold;
            margin-top: 30px;
            color: white;
            text-align: center;
            text-transform: uppercase;
        }

        .character-reveal-rarity {
            font-size: 24px;
            color: #ffcc00;
            margin-top: 10px;
            text-align: center;
        }

        .tap-to-continue {
            position: absolute;
            bottom: 50px;
            font-size: 20px;
            color: #ffcc00;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes sparkle {
            0%, 100% { filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.7)); }
            50% { filter: drop-shadow(0 0 20px rgba(255, 255, 255, 1)); }
        }

        .case-disabled {
            pointer-events: none;
            cursor: default;
        }

        .close-section-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            background: linear-gradient(45deg, #8A2BE2, #00ffff);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 101;
        }

        .close-section-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(138, 43, 226, 0.7);
        }

        .case-reward-step {
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 30px;
            animation: fadeIn 1s forwards;
        }

        .case-reward-step.active {
            display: flex;
        }

        .tap-to-continue-case {
            position: absolute;
            bottom: 100px;
            font-size: 20px;
            color: #ffcc00;
            animation: blink 1s infinite;
        }

        .remaining-items {
            position: absolute;
            bottom: 20px;
            left: 20px;
            font-size: 18px;
            color: #ffcc00;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px 20px;
            border-radius: 10px;
        }

        .preload-images {
            display: none;
        }

        @media (max-width: 1100px) {
            .character-list {
                grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            }
            
            .trophy-road-rewards {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }
            
            .apple-pass-rewards {
                grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            }
            
            .events-container {
                grid-template-columns: 1fr;
            }
            
            .events-btn {
                right: 30px;
                bottom: 100px;
            }
        }

        @media (max-width: 768px) {
            .game-title {
                font-size: 28px;
            }
            
            .character-lobby-icon {
                font-size: 150px;
                width: 250px;
                height: 250px;
            }
            
            .character-lobby-icon img {
                max-width: 200px;
                max-height: 200px;
            }
            
            .menu-buttons {
                flex-direction: column;
                gap: 12px;
            }
            
            .menu-btn {
                padding: 12px 25px;
                font-size: 16px;
            }
            
            .play-btn, .events-btn {
                padding: 15px 35px;
                font-size: 20px;
                bottom: 20px;
                right: 20px;
            }
            
            .events-btn {
                right: 20px;
                bottom: 80px;
            }
            
            .apple-case {
                width: 300px;
                height: 300px;
            }
            
            .shop-items {
                grid-template-columns: 1fr;
            }
            
            .game-header {
                padding: 10px;
            }
            
            .balance, .upgrade-level, .trophies-count, .crystals-count, .tickets-count, .fracture-energy-count {
                font-size: 18px;
            }
            
            .trophy-road-rewards {
                grid-template-columns: 1fr;
            }
            
            .mysterious-chest {
                width: 250px;
                height: 200px;
            }
            
            .apple-pass-icon {
                width: 60px;
                height: 60px;
                bottom: 20px;
                left: 20px;
            }
            
            .apple-pass-icon i {
                font-size: 24px;
            }
            
            .apple-pass-points {
                font-size: 12px;
            }
            
            .character-reveal-background {
                width: 300px;
                height: 300px;
            }
            
            .revealed-character {
                font-size: 80px;
            }
            
            .character-reveal-name {
                font-size: 24px;
            }
            
            .character-reveal-rarity {
                font-size: 18px;
            }
            
            .joystick-container {
                bottom: 80px;
                left: 80px;
                width: 120px;
                height: 120px;
            }
            
            .health-bar {
                width: 200px;
            }
            
            .fullscreen-btn {
                top: 10px;
                right: 10px;
                padding: 8px 12px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="preload-images">
        <img src="https://i.ibb.co/f7nMj9c/Picsart-25-12-09-23-02-46-736.png" alt="Яблочный кейс">
        <img src="https://i.ibb.co/VXgrSKx/Picsart-25-12-09-23-02-22-635.png" alt="Таинственный ящик">
        <img src="https://i.ibb.co/LXP8Z3Nw/f-bucks.png" alt="F-BUCKS">
    </div>
    
    <div class="cosmic-fissure"></div>
    <div class="floating-fragments" id="floating-fragments"></div>
    <div class="glitch-effect"></div>

    <button class="fullscreen-btn" id="fullscreen-btn">Полный экран</button>

    <div id="notification-container"></div>

    <div class="apple-pass-icon" id="apple-pass-icon">
        <i class="fas fa-apple-alt"></i>
        <div class="apple-pass-points" id="apple-pass-points">0</div>
    </div>

    <button class="events-btn" id="events-btn">События</button>

    <button class="play-btn" id="play-btn">Играть</button>

    <div class="game-header">
        <div class="balance-container">
            <div class="f-bucks-icon"></div>
            <div>
                <div class="balance" id="balance">10000</div>
                <div style="color: #aaa; font-size: 14px;">F-BUCKS</div>
            </div>
        </div>
        
        <div class="upgrade-container">
            <i class="fas fa-chart-line upgrade-icon"></i>
            <div>
                <div class="upgrade-level" id="upgrade-level">1</div>
                <div style="color: #aaa; font-size: 14px;">Уровень улучшения</div>
            </div>
        </div>
        
        <div class="trophies-container">
            <i class="fas fa-trophy trophy-icon"></i>
            <div>
                <div class="trophies-count" id="trophies-count">0</div>
                <div style="color: #aaa; font-size: 14px;">Кубки</div>
            </div>
        </div>

        <div class="crystals-container">
            <i class="fas fa-gem crystal-icon"></i>
            <div>
                <div class="crystals-count" id="crystals-count">0</div>
                <div style="color: #aaa; font-size: 14px;">Кристаллы</div>
            </div>
        </div>
        
        <div class="tickets-container">
            <i class="fas fa-ticket-alt ticket-icon"></i>
            <div>
                <div class="tickets-count" id="tickets-count">15</div>
                <div style="color: #aaa; font-size: 14px;">Билеты</div>
            </div>
        </div>

        <div class="fracture-energy-container">
            <i class="fas fa-bolt fracture-energy-icon"></i>
            <div>
                <div class="fracture-energy-count" id="fracture-energy-count">0</div>
                <div style="color: #aaa; font-size: 14px;">Энергия разлома</div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="content">
            <div class="main-menu" id="main-menu">
                <div class="season-badge">СЕЗОН 22: ЯБЛОЧНЫЙ РАЗЛОМ</div>
                <h1 class="game-title">Путешествие Яблока</h1>
                
                <div class="character-lobby-icon" id="character-lobby-icon">
                </div>
                
                <div class="menu-buttons">
                    <button class="menu-btn" id="characters-btn">
                        Персонажи
                    </button>
                    <button class="menu-btn" id="shop-btn">Магазин</button>
                    <button class="menu-btn" id="trophy-road-btn">
                        Трофейная дорога
                    </button>
                </div>
            </div>

            <div class="characters-section" id="characters-section">
                <button class="close-section-btn" id="close-characters-btn">✕</button>
                <h2 class="section-title">Персонажи</h2>
                
                <div class="character-tabs">
                    <button class="character-tab active" data-tab="all">В стиле путешествия яблока</button>
                    <button class="character-tab" data-tab="trophy">Трофейные</button>
                    <button class="character-tab" data-tab="exclusive">Эксклюзивы</button>
                </div>
                
                <div class="character-list" id="character-list">
                </div>
            </div>

            <div class="shop-section" id="shop-section">
                <button class="close-section-btn" id="close-shop-btn">✕</button>
                <h2 class="section-title">Магазин</h2>
                
                <div class="shop-items">
                    <div class="shop-item">
                        <i class="fas fa-chart-line shop-item-icon upgrade-icon-shop"></i>
                        <h3 class="shop-item-title">Улучшение клика</h3>
                        <p class="shop-item-description">Увеличивает количество F-BUCKS, получаемых за клик по персонажу. Максимальный уровень: 10000</p>
                        <div class="shop-item-price">
                            <div class="f-bucks-icon"></div>
                            <span id="upgrade-price">500</span>
                        </div>
                        <button class="buy-btn" id="buy-upgrade-btn">Купить улучшение</button>
                        <div class="max-upgrade" id="max-upgrade" style="display: none;">Достигнут максимальный уровень!</div>
                    </div>
                    
                    <div class="shop-item">
                        <div class="shop-item-icon apple-case-icon"></div>
                        <h3 class="shop-item-title">Яблочный Кейс</h3>
                        <p class="shop-item-description">Откройте кейс, чтобы получить F-BUCKS или уникального персонажа!</p>
                        <div class="shop-item-price">
                            <div class="f-bucks-icon"></div>
                            <span id="case-price">1000</span>
                        </div>
                        <button class="buy-btn" id="buy-case-btn">Купить кейс за 1000</button>
                    </div>
                    
                    <div class="shop-item">
                        <div class="shop-item-icon new-year-case-icon"></div>
                        <h3 class="shop-item-title">Новогодний Кейс</h3>
                        <p class="shop-item-description">Специальный новогодний кейс с эксклюзивными наградами! Доступен ограниченное время.</p>
                        <div class="shop-item-price">
                            <i class="fas fa-gem" style="color: #00ffff;"></i>
                            <span id="new-year-case-price">1000</span>
                        </div>
                        <button class="buy-btn" id="buy-new-year-case-btn">Купить за 1000 кристаллов</button>
                        <div class="new-year-timer" id="new-year-timer">
                            <div class="timer-title">Удаление через:</div>
                            <div class="timer-countdown" id="timer-countdown">00:00:00</div>
                        </div>
                    </div>
                    
                    <div class="shop-item">
                        <div class="shop-item-icon rift-case-icon"></div>
                        <h3 class="shop-item-title">Кейс "Разлом"</h3>
                        <p class="shop-item-description">Новый сезонный кейс с персонажами из разлома реальности!</p>
                        <div class="shop-item-price">
                            <i class="fas fa-bolt" style="color: #8A2BE2;"></i>
                            <span id="rift-case-price">50</span>
                        </div>
                        <button class="buy-btn" id="buy-rift-case-btn">Купить за 50 энергии</button>
                    </div>
                    
                    <div class="shop-item">
                        <div class="shop-item-icon anomaly-case-icon"></div>
                        <h3 class="shop-item-title">Кейс "Аномалия"</h3>
                        <p class="shop-item-description">Эксклюзивный кейс с шансом выпадения аномальных персонажей!</p>
                        <div class="shop-item-price">
                            <i class="fas fa-gem" style="color: #00ffff;"></i>
                            <span id="anomaly-case-price">500</span>
                        </div>
                        <button class="buy-btn" id="buy-anomaly-case-btn">Купить за 500 кристаллов</button>
                        <div style="color: #ffcc00; margin-top: 10px; font-size: 14px; text-align: center;">
                            Гарант: 1 аномальный каждые 20 кейсов
                        </div>
                    </div>
                    
                    <div class="shop-item exclusive-character-item">
                        <i class="fas fa-crown shop-item-icon" style="color: #FFD700; font-size: 40px;"></i>
                        <h3 class="shop-item-title">❄️ Морозное яблоко</h3>
                        <p class="shop-item-description">Эксклюзивный персонаж с ледяной магией</p>
                        <div class="shop-item-price">
                            <i class="fas fa-gem" style="color: #00ffff;"></i>
                            <span>100000</span>
                        </div>
                        <button class="buy-btn" id="buy-exclusive-20-btn">Купить за 100k кристаллов</button>
                    </div>
                    
                    <div class="shop-item exclusive-character-item">
                        <i class="fas fa-crown shop-item-icon" style="color: #FFD700; font-size: 40px;"></i>
                        <h3 class="shop-item-title">💀 Череп</h3>
                        <p class="shop-item-description">Эксклюзивный персонаж со скелетной силой</p>
                        <div class="shop-item-price">
                            <i class="fas fa-gem" style="color: #00ffff;"></i>
                            <span>100000</span>
                        </div>
                        <button class="buy-btn" id="buy-exclusive-21-btn">Купить за 100k кристаллов</button>
                    </div>
                    
                    <div class="shop-item exclusive-character-item">
                        <i class="fas fa-crown shop-item-icon" style="color: #FFD700; font-size: 40px;"></i>
                        <h3 class="shop-item-title">⚠️ Аномальное яблоко</h3>
                        <p class="shop-item-description">Эксклюзивный персонаж с аномальной силой</p>
                        <div class="shop-item-price">
                            <i class="fas fa-gem" style="color: #00ffff;"></i>
                            <span>100000</span>
                        </div>
                        <button class="buy-btn" id="buy-exclusive-27-btn">Купить за 100k кристаллов</button>
                    </div>
                    
                    <div class="shop-item exclusive-character-item">
                        <i class="fas fa-crown shop-item-icon" style="color: #FFD700; font-size: 40px;"></i>
                        <h3 class="shop-item-title">💥 Разломщик Реальности</h3>
                        <p class="shop-item-description">Эксклюзивный персонаж с силой разлома</p>
                        <div class="shop-item-price">
                            <i class="fas fa-gem" style="color: #00ffff;"></i>
                            <span>100000</span>
                        </div>
                        <button class="buy-btn" id="buy-exclusive-28-btn">Купить за 100k кристаллов</button>
                    </div>
                    
                    <div class="shop-item promo-section">
                        <h3 class="shop-item-title">ПРОМОКОДЫ</h3>
                        <p class="shop-item-description">Введите промокод для получения наград</p>
                        <div class="promo-input">
                            <input type="text" id="promo-code-input" placeholder="Введите промокод">
                            <button id="use-promo-btn">Активировать</button>
                        </div>
                        <div id="promo-message" style="margin-top: 10px; color: #ffcc00; text-align: center;"></div>
                    </div>
                </div>
            </div>
            
            <div class="trophy-road-section" id="trophy-road-section">
                <button class="close-section-btn" id="close-trophy-road-btn">✕</button>
                <h2 class="section-title">Трофейная дорога</h2>
                <div class="trophy-road-container">
                    <div class="trophy-road-progress">
                        <div class="trophy-road-bar">
                            <div class="trophy-road-fill" id="trophy-road-fill"></div>
                        </div>
                        <div class="trophy-road-text">
                            <span id="current-trophies">0 кубков</span>
                            <span id="next-milestone">10 кубков</span>
                        </div>
                    </div>
                    
                    <div class="trophy-road-rewards" id="trophy-road-rewards">
                    </div>
                </div>
            </div>
            
            <div class="events-section" id="events-section">
                <button class="close-section-btn" id="close-events-btn">✕</button>
                <h2 class="section-title">СОБЫТИЯ</h2>
                
                <div class="events-container">
                    <div class="event-card">
                        <div class="event-icon">🍎</div>
                        <h3 class="event-title">Ловля яблок</h3>
                        <p class="event-description">Поймайте как можно больше яблок за 30 секунд. Отличный способ заработать кубки!</p>
                        <div class="event-reward">Награда: Кубки (10-100)</div>
                        <button class="event-play-btn" id="play-apple-catching-btn">Играть</button>
                    </div>
                    
                    <div class="event-card premium">
                        <div class="event-icon">⚔️</div>
                        <h3 class="event-title">Выживание</h3>
                        <p class="event-description">Продержитесь 2 минуты против красного яблока. Используйте джойстик для движения.</p>
                        <div class="event-reward">Награда: 100 кристаллов</div>
                        <div class="event-requirements" id="survival-tickets-info">Требуется: 1 билет (осталось: 15)</div>
                        <button class="event-play-btn premium" id="play-survival-btn">Играть</button>
                    </div>
                    
                    <div class="event-card champion-challenge-event">
                        <div class="event-icon">🏆</div>
                        <h3 class="event-title">Ранговое испытание</h3>
                        <p class="event-description">Пройдите ранговый турнир со своим персонажем и получите кубки для повышения ранга!</p>
                        <div class="event-reward">Награда: Кубки персонажу (30-150)</div>
                        <div class="event-requirements" id="champion-energy-info">Энергия: 1 (восстанавливается каждый час)</div>
                        <button class="event-play-btn champion" id="play-champion-challenge-btn">Играть</button>
                    </div>
                    
                    <div class="event-card reality-rift-event">
                        <div class="event-icon">🔮</div>
                        <h3 class="event-title">Разлом Реальности</h3>
                        <p class="event-description">
                            Улучшенное выживание с волнами врагов и случайными модификаторами!
                            <br><br>
                            Возможные модификаторы:
                            <span class="modifier-badge">Ускорение времени</span>
                            <span class="modifier-badge">Зеркальное управление</span>
                            <span class="modifier-badge">Двойной урон</span>
                        </p>
                        <div class="event-reward">Награда: Энергия разлома, кейсы, прогресс Apple Pass</div>
                        <div class="event-requirements" id="reality-rift-tickets-info">Требуется: 2 билета</div>
                        <button class="event-play-btn" id="play-reality-rift-btn">Играть</button>
                    </div>
                </div>
            </div>
            
            <div class="apple-pass-section" id="apple-pass-section">
                <button class="close-section-btn" id="close-apple-pass-btn">✕</button>
                <h2 class="section-title">APPLE PASS</h2>
                <div class="apple-pass-season-title" id="apple-pass-season-title">22 СЕЗОН: ЯБЛОЧНЫЙ РАЗЛОМ</div>
                <div class="apple-pass-rewards" id="apple-pass-rewards">
                </div>
            </div>
        </div>
        
        <div class="survival-game" id="survival-game">
            <div class="survival-header">
                <div class="survival-timer" id="survival-timer">02:00</div>
                <div class="survival-health">
                    <div class="health-bar">
                        <div class="health-fill" id="survival-health-fill"></div>
                    </div>
                    <div class="health-text" id="survival-health-text">5000/5000</div>
                </div>
            </div>
            
            <div class="survival-game-area" id="survival-game-area">
            </div>
            
            <div class="joystick-container" id="joystick-container">
                <div class="joystick-base"></div>
                <div class="joystick-handle" id="joystick-handle"></div>
            </div>
            
            <button class="exit-survival-btn" id="exit-survival-btn">Выйти</button>
        </div>
        
        <div class="case-opening" id="case-opening">
            <div class="case-container">
                <h2 class="case-title" id="case-opening-title">Откройте Яблочный Кейс!</h2>
                <div class="apple-case" id="apple-case">
                    <i class="fas fa-lock case-lock"></i>
                    <div class="case-hint" id="case-hint">Жми! Жми!</div>
                </div>
                <div class="case-count" id="case-count">Предметов: 0</div>
                
                <div class="case-reward-step" id="case-reward-step-1">
                    <div class="reward-item">
                        <div class="reward-fbucks-icon"></div>
                        <div class="reward-text reward-money" id="case-money-reward">F-BUCKS: +0</div>
                    </div>
                    <div class="remaining-items" id="remaining-items">Осталось предметов: 0</div>
                    <div class="tap-to-continue-case" id="tap-to-continue-case">Нажмите чтобы продолжить</div>
                </div>
                
                <div class="case-reward-step" id="case-reward-step-2">
                    <div class="reward-item">
                        <div class="reward-icon" id="case-character-icon"></div>
                        <div class="reward-text reward-character" id="case-character-text"></div>
                    </div>
                    <div class="tap-to-continue-case">Нажмите чтобы продолжить</div>
                </div>
                
                <button class="close-case-btn" id="close-case-btn">Вернуться в магазин</button>
            </div>
        </div>
        
        <div class="apple-catching-game" id="apple-catching-game">
            <div class="game-header-bar">
                <div class="game-timer" id="game-timer">30</div>
                <div class="game-score" id="game-score">0</div>
            </div>
            <div class="game-target" id="game-target">Поймайте 20 яблок за 30 секунд!</div>
            <div class="game-end-screen" id="game-end-screen">
                <div class="game-result" id="game-result"></div>
                <div class="game-stats" id="game-stats"></div>
                <button class="exit-game-btn" id="exit-game-btn">Выйти</button>
            </div>
        </div>
        
        <div class="mysterious-chest-opening" id="mysterious-chest-opening">
            <div class="mysterious-chest-container">
                <h2 class="mysterious-chest-title">Таинственный ящик</h2>
                <div class="mysterious-chest" id="mysterious-chest">
                    <div class="chest-crack" id="chest-crack-1"></div>
                    <div class="chest-crack" id="chest-crack-2"></div>
                    <div class="chest-crack" id="chest-crack-3"></div>
                    <div class="chest-crack" id="chest-crack-4"></div>
                    <div class="chest-crack" id="chest-crack-5"></div>
                </div>
                <div class="chest-tap-counter" id="chest-tap-counter">Нажмите на ящик: 0/5</div>
                
                <div class="case-reward-step" id="mysterious-chest-reward-step-1">
                    <div class="reward-item">
                        <div class="reward-fbucks-icon"></div>
                        <div class="reward-text reward-money" id="mysterious-chest-money-reward">F-BUCKS: +0</div>
                    </div>
                    <div class="remaining-items" id="mysterious-chest-remaining-items">Осталось предметов: 0</div>
                    <div class="tap-to-continue-case">Нажмите чтобы продолжить</div>
                </div>
                
                <div class="case-reward-step" id="mysterious-chest-reward-step-2">
                    <div class="reward-item">
                        <div class="reward-icon" id="mysterious-chest-character-icon"></div>
                        <div class="reward-text reward-character" id="mysterious-chest-character-text"></div>
                    </div>
                    <div class="tap-to-continue-case">Нажмите чтобы продолжить</div>
                </div>
                
                <button class="close-chest-btn" id="close-chest-btn" style="display: none;">Забрать награду</button>
            </div>
        </div>
        
        <div class="character-reveal-overlay" id="character-reveal-overlay">
            <div class="character-reveal-container">
                <div class="character-reveal-background" id="character-reveal-background">
                    <div class="revealed-character" id="revealed-character"></div>
                </div>
                <div class="character-reveal-name" id="character-reveal-name"></div>
                <div class="character-reveal-rarity" id="character-reveal-rarity"></div>
                <div class="tap-to-continue">Нажмите чтобы продолжить</div>
            </div>
        </div>
    </div>

    <audio id="background-music" loop>
        <source src="https://assets.mixkit.co/music/preview/mixkit-game-show-suspense-waiting-667.mp3" type="audio/mpeg">
    </audio>

    <script>
        // === SEASON 22 START ===
        const SEASON_22_START = Date.now();
        const NEW_YEAR_CASE_REMOVAL_DATE = new Date('2024-02-15T11:00:00+03:00');
        
        const ANOMALY_CASE_CHANCES = {
            money: 40,
            common_character: 20,
            rare_character: 15,
            epic_character: 10,
            legendary_character: 8,
            mythic_character: 5,
            anomaly_character: 2
        };
        
        let anomalyCaseCounter = 0;
        const ANOMALY_GUARANTEE = 20;
        // === SEASON 22 END ===

        let playerHealth = 5000;
        let maxHealth = 5000;
        let lastDamageTime = 0;
        const DAMAGE_COOLDOWN = 300;
        let isOpeningCase = false;

        // === PATCH: Флаг для отслеживания открытия кейса из Apple Pass ===
        let openingCaseFromApplePass = false;
        let openingCaseFromTrophyRoad = false;

        let gameData = {
            balance: 10000,
            upgradeLevel: 1,
            maxUpgradeLevel: 10000,
            characters: [],
            unlockedCharacters: [1],
            selectedCharacterId: 1,
            trophies: 0,
            crystals: 0,
            claimedRewards: [],
            caseItems: 0,
            musicEnabled: true,
            gameActive: false,
            gameTime: 30,
            gameScore: 0,
            gameTimer: null,
            apples: [],
            chestTaps: 0,
            chestMaxTaps: 5,
            chestOpening: false,
            chestsToOpen: 0,
            tickets: 15,
            lastTicketReset: null,
            survivalWins: 0,
            survivalBestTime: 0,
            applePassPoints: 0,
            applePassClaimedRewards: [],
            hasCharacterReveal: false,
            revealedCharacter: null,
            caseAnimationInProgress: false,
            mysteriousChestAnimationInProgress: false,
            currentCaseRewards: [],
            currentCaseStep: 0,
            currentMysteriousChestRewards: [],
            currentMysteriousChestStep: 0,
            usedPromoCodes: [],
            skullCharacterUnlocked: false,
            fractureEnergy: 0,
            season22Data: {
                anomalyCasesOpened: 0,
                riftCasesOpened: 0,
                realityRiftWins: 0,
                anomalyCharactersUnlocked: [],
                fractureCharactersUnlocked: [],
                applePass22Points: 0,
                applePass22Claimed: []
            },
            newYearCaseAvailable: true,
            characterTrophies: {},
            championEnergy: 1,
            lastChampionEnergyReset: null
        };

        const charactersData = [
            { id: 1, name: "Яблоко", rarity: "common", icon: "🍎", colorClass: "rarity-common", borderClass: "border-common" },
            { id: 2, name: "Яблоко-рыцарь", rarity: "rare", icon: "🛡️", colorClass: "rarity-rare", borderClass: "border-rare" },
            { id: 3, name: "Золотое яблоко", rarity: "rare", icon: "🍏", colorClass: "rarity-rare", borderClass: "border-rare" },
            { id: 4, name: "Яблоко-чудовище", rarity: "super-rare", icon: "👹", colorClass: "rarity-super-rare", borderClass: "border-super-rare" },
            { id: 5, name: "Яблоко-кот", rarity: "epic", icon: "🐱", colorClass: "rarity-epic", borderClass: "border-epic" },
            { id: 6, name: "Магмовое яблоко", rarity: "mythic", icon: "🌋", colorClass: "rarity-mythic", borderClass: "border-mythic" },
            { id: 7, name: "Яблоко-ангел", rarity: "legendary", icon: "👼", colorClass: "rarity-legendary", borderClass: "border-legendary" },
            { id: 8, name: "Яблоко-человек", rarity: "epic", icon: "👨", colorClass: "rarity-epic", borderClass: "border-epic" },
            { 
                id: 9, 
                name: "ГУБКА БОБ", 
                rarity: "monochrome", 
                icon: '<img src="https://images2.deviantart.net/8d3c/b9b2/3d7694208/d937694208-spongebob-3d-model.png" alt="Губка Боб" style="max-width: 100%; max-height: 100%; object-fit: contain;">', 
                colorClass: "rarity-monochrome", 
                borderClass: "border-monochrome" 
            },
            { id: 10, name: "Яблоко-рэпер", rarity: "epic", icon: "🎤", colorClass: "rarity-epic", borderClass: "border-epic" },
            { id: 11, name: "Улыбающееся яблоко", rarity: "mythic", icon: "😊", colorClass: "rarity-mythic", borderClass: "border-mythic" },
            { id: 12, name: "Сеньор яблоко", rarity: "epic", icon: "🧓", colorClass: "rarity-epic", borderClass: "border-epic" },
            { id: 13, name: "Ухоженное яблоко", rarity: "epic", icon: "💅", colorClass: "rarity-epic", borderClass: "border-epic" },
            { id: 14, name: "Скелет яблоко", rarity: "epic", icon: "💀", colorClass: "rarity-epic", borderClass: "border-epic" },
            { id: 15, name: "Песочное яблоко", rarity: "mythic", icon: "🏖️", colorClass: "rarity-mythic", borderClass: "border-mythic" },
            { id: 16, name: "Яблоко-чемпион", rarity: "trophy", icon: "🥇", colorClass: "rarity-trophy", borderClass: "border-trophy" },
            { id: 17, name: "Яблоко-киберспортсмен", rarity: "trophy", icon: "🎮", colorClass: "rarity-trophy", borderClass: "border-trophy" },
            { id: 18, name: "Яблоко-про", rarity: "trophy", icon: "👑", colorClass: "rarity-trophy", borderClass: "border-trophy" },
            { id: 19, name: "Яблочный сок", rarity: "trophy", icon: "🥤", colorClass: "rarity-trophy", borderClass: "border-trophy" },
            { id: 20, name: "Морозное яблоко", rarity: "exclusive", icon: "❄️🍎", colorClass: "rarity-exclusive", borderClass: "border-exclusive" },
            { id: 21, name: "Череп", rarity: "exclusive", icon: "💀", colorClass: "rarity-exclusive", borderClass: "border-exclusive" },
            { id: 22, name: "Путник Разлома", rarity: "common", icon: "🍎🌀", colorClass: "rarity-common", borderClass: "border-common" },
            { id: 23, name: "Искажённое Яблоко", rarity: "rare", icon: "🍎💫", colorClass: "rarity-rare", borderClass: "border-rare" },
            { id: 24, name: "Глитч-Плод", rarity: "epic", icon: "🍎✨", colorClass: "rarity-epic", borderClass: "border-epic" },
            { id: 25, name: "Хранитель Разломов", rarity: "legendary", icon: "🍎👁️", colorClass: "rarity-legendary", borderClass: "border-legendary" },
            { id: 26, name: "Яблоко Парадокса", rarity: "mythic", icon: "🍎🌌", colorClass: "rarity-mythic", borderClass: "border-mythic" },
            { id: 27, name: "Аномальное яблоко", rarity: "exclusive", icon: "🍎⚠️", colorClass: "rarity-exclusive", borderClass: "border-exclusive" },
            { id: 28, name: "Разломщик Реальности", rarity: "exclusive", icon: "🍎💥", colorClass: "rarity-exclusive", borderClass: "border-exclusive" },
            { id: 29, name: "Лосось Рангов", rarity: "trophy", icon: "🐟", colorClass: "rarity-trophy", borderClass: "border-trophy" },
            { id: 30, name: "Яблоко Диаманда", rarity: "trophy", icon: "💎", colorClass: "rarity-trophy", borderClass: "border-trophy" },
            { id: 31, name: "Мифическое Яблоко", rarity: "trophy", icon: "🦄", colorClass: "rarity-trophy", borderClass: "border-trophy" },
            { id: 32, name: "Легендарный Плод", rarity: "trophy", icon: "⭐", colorClass: "rarity-trophy", borderClass: "border-trophy" },
            { id: 33, name: "Яблоко Вечности", rarity: "trophy", icon: "♾️", colorClass: "rarity-trophy", borderClass: "border-trophy" },
            { id: 34, name: "Верховный Правитель", rarity: "trophy", icon: "🏆", colorClass: "rarity-trophy", borderClass: "border-trophy" },
            { id: 35, name: "Апекс Яблок", rarity: "trophy", icon: "🥇", colorClass: "rarity-trophy", borderClass: "border-trophy" }
        ];

        const rarityNames = {
            "common": "Обычный",
            "rare": "Редкий",
            "super-rare": "Сверхредкий",
            "epic": "Эпический",
            "mythic": "Мифический",
            "legendary": "Легендарный",
            "monochrome": "Монохромный",
            "trophy": "Трофейный",
            "exclusive": "Эксклюзивный"
        };

        const trophyRoadRewards = [
            { trophies: 10, reward: { type: "mysterious_chest", amount: 1 } },
            { trophies: 50, reward: { type: "money", amount: 2000 } },
            { trophies: 100, reward: { type: "mysterious_chest", amount: 1 } },
            { trophies: 150, reward: { type: "money", amount: 10000 } },
            { trophies: 200, reward: { type: "mysterious_chest", amount: 1 } },
            { trophies: 250, reward: { type: "money", amount: 20000 } },
            { trophies: 300, reward: { type: "mysterious_chest", amount: 1 } },
            { trophies: 350, reward: { type: "money", amount: 25000 } },
            { trophies: 400, reward: { type: "mysterious_chest", amount: 1 } },
            { trophies: 450, reward: { type: "money", amount: 30000 } },
            { trophies: 500, reward: { type: "mysterious_chest", amount: 2, milestone: true } },
            { trophies: 600, reward: { type: "money", amount: 40000 } },
            { trophies: 700, reward: { type: "mysterious_chest", amount: 1 } },
            { trophies: 800, reward: { type: "money", amount: 50000 } },
            { trophies: 900, reward: { type: "mysterious_chest", amount: 1 } },
            { trophies: 1000, reward: { type: "mysterious_chest", amount: 2, milestone: true } },
            { trophies: 1500, reward: { type: "money", amount: 50000 } },
            { trophies: 2000, reward: { type: "mysterious_chest", amount: 1 } },
            { trophies: 2500, reward: { type: "money", amount: 60000 } },
            { trophies: 3000, reward: { type: "mysterious_chest", amount: 1 } },
            { trophies: 3500, reward: { type: "money", amount: 70000 } },
            { trophies: 4000, reward: { type: "mysterious_chest", amount: 1 } },
            { trophies: 4500, reward: { type: "money", amount: 80000 } },
            { trophies: 5000, reward: { type: "mysterious_chest", amount: 2, milestone: true } },
            { trophies: 5500, reward: { type: "money", amount: 90000 } },
            { trophies: 6000, reward: { type: "mysterious_chest", amount: 1 } },
            { trophies: 6500, reward: { type: "money", amount: 100000 } },
            { trophies: 7000, reward: { type: "mysterious_chest", amount: 1 } },
            { trophies: 7500, reward: { type: "money", amount: 120000 } },
            { trophies: 8000, reward: { type: "mysterious_chest", amount: 1 } },
            { trophies: 8500, reward: { type: "money", amount: 140000 } },
            { trophies: 9000, reward: { type: "mysterious_chest", amount: 1 } },
            { trophies: 9500, reward: { type: "money", amount: 200000 } },
            { trophies: 10000, reward: { type: "mysterious_chest", amount: 5, milestone: true } },
            { trophies: 11000, reward: { type: "crystals", amount: 100 } },
            { trophies: 12000, reward: { type: "mysterious_chest", amount: 2 } },
            { trophies: 13000, reward: { type: "crystals", amount: 100 } },
            { trophies: 14000, reward: { type: "mysterious_chest", amount: 3 } },
            { trophies: 15000, reward: { type: "crystals", amount: 500, milestone: true } },
            { trophies: 16000, reward: { type: "mysterious_chest", amount: 4 } },
            { trophies: 17000, reward: { type: "crystals", amount: 100 } },
            { trophies: 18000, reward: { type: "mysterious_chest", amount: 5 } },
            { trophies: 19000, reward: { type: "crystals", amount: 100 } },
            { trophies: 20000, reward: { type: "mysterious_chest", amount: 10, milestone: true } },
            { trophies: 21000, reward: { type: "mysterious_chest", amount: 2 } },
            { trophies: 22000, reward: { type: "mysterious_chest", amount: 2 } },
            { trophies: 23000, reward: { type: "crystals", amount: 200 } },
            { trophies: 24000, reward: { type: "mysterious_chest", amount: 3 } },
            { trophies: 25000, reward: { type: "mysterious_chest", amount: 3, milestone: true } },
            { trophies: 26000, reward: { type: "mysterious_chest", amount: 3 } },
            { trophies: 27000, reward: { type: "crystals", amount: 300 } },
            { trophies: 28000, reward: { type: "mysterious_chest", amount: 4 } },
            { trophies: 29000, reward: { type: "mysterious_chest", amount: 3 } },
            { trophies: 30000, reward: { type: "mysterious_chest", amount: 5, milestone: true } },
            { trophies: 32000, reward: { type: "crystals", amount: 500 } },
            { trophies: 34000, reward: { type: "crystals", amount: 500 } },
            { trophies: 36000, reward: { type: "mysterious_chest", amount: 5 } },
            { trophies: 38000, reward: { type: "mysterious_chest", amount: 6 } },
            { trophies: 40000, reward: { type: "mysterious_chest", amount: 8, milestone: true } },
            { trophies: 50000, reward: { type: "mysterious_chest", amount: 10, milestone: true, label: "🆕 НОВЫЙ РУБЕЖ" } },
            { trophies: 60000, reward: { type: "crystals", amount: 1500, milestone: true, label: "🆕 НОВЫЙ РУБЕЖ" } },
            { trophies: 70000, reward: { type: "crystals", amount: 1000 } },
            { trophies: 80000, reward: { type: "mysterious_chest", amount: 10, milestone: true, label: "🆕 НОВЫЙ РУБЕЖ" } },
            { trophies: 90000, reward: { type: "crystals", amount: 1500 } },
            { trophies: 100000, reward: { type: "mysterious_chest", amount: 15, milestone: true, label: "🆕 НОВЫЙ РУБЕЖ" } }
        ];

        const applePass22Rewards = [
            { points: 0, reward: { type: "rift_case", amount: 1 } },
            { points: 150, reward: { type: "crystals", amount: 100 } },
            { points: 300, reward: { type: "anomaly_case", amount: 1 } },
            { points: 450, reward: { type: "fracture_energy", amount: 50 } },
            { points: 650, reward: { type: "rift_case", amount: 2 } },
            { points: 850, reward: { type: "crystals", amount: 150 } },
            { points: 1100, reward: { type: "anomaly_case", amount: 1 } },
            { points: 1400, reward: { type: "fracture_energy", amount: 75 } },
            { points: 1750, reward: { type: "crystals", amount: 200 } },
            { points: 2150, reward: { type: "character", characterId: 22 } },
            { points: 2600, reward: { type: "rift_case", amount: 2 } },
            { points: 3100, reward: { type: "anomaly_case", amount: 1 } },
            { points: 3650, reward: { type: "crystals", amount: 250 } },
            { points: 4250, reward: { type: "fracture_energy", amount: 100 } },
            { points: 4900, reward: { type: "rift_case", amount: 2 } },
            { points: 5600, reward: { type: "crystals", amount: 300 } },
            { points: 6350, reward: { type: "anomaly_case", amount: 1 } },
            { points: 7150, reward: { type: "fracture_energy", amount: 150 } },
            { points: 8000, reward: { type: "crystals", amount: 350 } },
            { points: 8900, reward: { type: "rift_case", amount: 3 } },
            { points: 9850, reward: { type: "anomaly_case", amount: 2 } },
            { points: 10850, reward: { type: "fracture_energy", amount: 100 } },
            { points: 11900, reward: { type: "crystals", amount: 400 } },
            { points: 13000, reward: { type: "rift_case", amount: 2 } },
            { points: 14150, reward: { type: "anomaly_case", amount: 1 } },
            { points: 15350, reward: { type: "crystals", amount: 450 } },
            { points: 16600, reward: { type: "fracture_energy", amount: 200 } },
            { points: 17900, reward: { type: "rift_case", amount: 3 } },
            { points: 19250, reward: { type: "crystals", amount: 500 } },
            { points: 20650, reward: { type: "anomaly_case", amount: 3 } },
            { points: 22100, reward: { type: "rift_case", amount: 3 } },
            { points: 23600, reward: { type: "crystals", amount: 400 } },
            { points: 25150, reward: { type: "crystals", amount: 600 } },
            { points: 26750, reward: { type: "fracture_energy", amount: 250 } },
            { points: 28400, reward: { type: "anomaly_case", amount: 2 } },
            { points: 30100, reward: { type: "crystals", amount: 700 } },
            { points: 31850, reward: { type: "rift_case", amount: 2 } },
            { points: 33650, reward: { type: "fracture_energy", amount: 300 } },
            { points: 35500, reward: { type: "crystals", amount: 800 } },
            { points: 37400, reward: { type: "anomaly_case", amount: 4 } },
            { points: 39400, reward: { type: "rift_case", amount: 3 } },
            { points: 41500, reward: { type: "crystals", amount: 600 } },
            { points: 43700, reward: { type: "crystals", amount: 900 } },
            { points: 46000, reward: { type: "fracture_energy", amount: 400 } },
            { points: 48400, reward: { type: "anomaly_case", amount: 3 } },
            { points: 50900, reward: { type: "crystals", amount: 1000 } },
            { points: 53500, reward: { type: "rift_case", amount: 4 } },
            { points: 56200, reward: { type: "fracture_energy", amount: 500 } },
            { points: 59000, reward: { type: "crystals", amount: 1200 } },
            { points: 61900, reward: { type: "legendary_character", characterId: 25 } }
        ];

        const applePassRewards = [
            { points: 0, reward: { type: "money", amount: 5000 } },
            { points: 100, reward: { type: "money", amount: 10000 } },
            { points: 200, reward: { type: "upgrade", amount: 5 } },
            { points: 300, reward: { type: "crystals", amount: 50 } },
            { points: 400, reward: { type: "money", amount: 50000 } },
            { points: 500, reward: { type: "upgrade", amount: 10 } },
            { points: 600, reward: { type: "crystals", amount: 100 } },
            { points: 700, reward: { type: "money", amount: 100000 } },
            { points: 800, reward: { type: "money", amount: 150000 } },
            { points: 900, reward: { type: "crystals", amount: 200 } },
            { points: 1000, reward: { type: "upgrade", amount: 20 } },
            { points: 1200, reward: { type: "money", amount: 300000 } },
            { points: 1400, reward: { type: "crystals", amount: 300 } },
            { points: 1600, reward: { type: "upgrade", amount: 30 } },
            { points: 1800, reward: { type: "money", amount: 500000 } },
            { points: 1900, reward: { type: "crystals", amount: 500 } },
            { points: 2000, reward: { type: "upgrade", amount: 50 } }
        ];

        const promoCodes = {
            "мишкан": { type: "crystals", amount: 300 },
            "EpicLines": { type: "crystals", amount: 50 },
            "RELEASE": { type: "money", amount: 100000 },
            "секси мишкан": { type: "crystals", amount: 100 },
            "бобик": { type: "crystals", amount: 250 },
            "WHEREISCHEREP?": { type: "character", characterId: 21 },
            "АНОМАЛИЯ": { type: "anomaly_case", amount: 1 },
            "СЕЗОН22": { type: "crystals", amount: 1000 }
        };

        // Получаем элементы DOM
        const balanceElement = document.getElementById('balance');
        const upgradeLevelElement = document.getElementById('upgrade-level');
        const trophiesCountElement = document.getElementById('trophies-count');
        const crystalsCountElement = document.getElementById('crystals-count');
        const ticketsCountElement = document.getElementById('tickets-count');
        const applePassPointsElement = document.getElementById('apple-pass-points');
        const fractureEnergyCountElement = document.getElementById('fracture-energy-count');
        const mainMenuElement = document.getElementById('main-menu');
        const charactersSectionElement = document.getElementById('characters-section');
        const shopSectionElement = document.getElementById('shop-section');
        const trophyRoadSectionElement = document.getElementById('trophy-road-section');
        const eventsSectionElement = document.getElementById('events-section');
        const applePassSectionElement = document.getElementById('apple-pass-section');
        const characterLobbyIconElement = document.getElementById('character-lobby-icon');
        const characterListElement = document.getElementById('character-list');
        const caseOpeningElement = document.getElementById('case-opening');
        const appleCatchingGameElement = document.getElementById('apple-catching-game');
        const survivalGameElement = document.getElementById('survival-game');
        const mysteriousChestOpeningElement = document.getElementById('mysterious-chest-opening');
        const characterRevealOverlayElement = document.getElementById('character-reveal-overlay');
        
        // Кнопки
        const buyUpgradeBtn = document.getElementById('buy-upgrade-btn');
        const buyCaseBtn = document.getElementById('buy-case-btn');
        const buyNewYearCaseBtn = document.getElementById('buy-new-year-case-btn');
        const buyRiftCaseBtn = document.getElementById('buy-rift-case-btn');
        const buyAnomalyCaseBtn = document.getElementById('buy-anomaly-case-btn');
        const buyExclusive20Btn = document.getElementById('buy-exclusive-20-btn');
        const buyExclusive21Btn = document.getElementById('buy-exclusive-21-btn');
        const buyExclusive27Btn = document.getElementById('buy-exclusive-27-btn');
        const buyExclusive28Btn = document.getElementById('buy-exclusive-28-btn');
        const appleCaseElement = document.getElementById('apple-case');
        const caseHintElement = document.getElementById('case-hint');
        const caseCountElement = document.getElementById('case-count');
        const closeCaseBtn = document.getElementById('close-case-btn');
        const playBtn = document.getElementById('play-btn');
        const eventsBtn = document.getElementById('events-btn');
        const charactersBtn = document.getElementById('characters-btn');
        const shopBtn = document.getElementById('shop-btn');
        const trophyRoadBtn = document.getElementById('trophy-road-btn');
        const playAppleCatchingBtn = document.getElementById('play-apple-catching-btn');
        const playSurvivalBtn = document.getElementById('play-survival-btn');
        const playChampionChallengeBtn = document.getElementById('play-champion-challenge-btn');
        const playRealityRiftBtn = document.getElementById('play-reality-rift-btn');
        const applePassIconElement = document.getElementById('apple-pass-icon');
        const backgroundMusic = document.getElementById('background-music');
        const upgradePriceElement = document.getElementById('upgrade-price');
        const maxUpgradeElement = document.getElementById('max-upgrade');
        const gameTimerElement = document.getElementById('game-timer');
        const gameScoreElement = document.getElementById('game-score');
        const gameTargetElement = document.getElementById('game-target');
        const gameEndScreenElement = document.getElementById('game-end-screen');
        const gameResultElement = document.getElementById('game-result');
        const gameStatsElement = document.getElementById('game-stats');
        const exitGameBtn = document.getElementById('exit-game-btn');
        const trophyRoadFillElement = document.getElementById('trophy-road-fill');
        const currentTrophiesElement = document.getElementById('current-trophies');
        const nextMilestoneElement = document.getElementById('next-milestone');
        const trophyRoadRewardsElement = document.getElementById('trophy-road-rewards');
        const mysteriousChestElement = document.getElementById('mysterious-chest');
        const chestTapCounterElement = document.getElementById('chest-tap-counter');
        const closeChestBtn = document.getElementById('close-chest-btn');
        const chestCrack1 = document.getElementById('chest-crack-1');
        const chestCrack2 = document.getElementById('chest-crack-2');
        const chestCrack3 = document.getElementById('chest-crack-3');
        const chestCrack4 = document.getElementById('chest-crack-4');
        const chestCrack5 = document.getElementById('chest-crack-5');
        
        const survivalTimerElement = document.getElementById('survival-timer');
        const survivalHealthFillElement = document.getElementById('survival-health-fill');
        const survivalHealthTextElement = document.getElementById('survival-health-text');
        const survivalGameAreaElement = document.getElementById('survival-game-area');
        const joystickContainerElement = document.getElementById('joystick-container');
        const joystickHandleElement = document.getElementById('joystick-handle');
        const exitSurvivalBtn = document.getElementById('exit-survival-btn');
        const survivalTicketsInfoElement = document.getElementById('survival-tickets-info');
        const realityRiftTicketsInfoElement = document.getElementById('reality-rift-tickets-info');
        
        const characterRevealBackgroundElement = document.getElementById('character-reveal-background');
        const revealedCharacterElement = document.getElementById('revealed-character');
        const characterRevealNameElement = document.getElementById('character-reveal-name');
        const characterRevealRarityElement = document.getElementById('character-reveal-rarity');
        
        const applePassSeasonTitleElement = document.getElementById('apple-pass-season-title');
        const applePassRewardsElement = document.getElementById('apple-pass-rewards');
        
        const closeCharactersBtn = document.getElementById('close-characters-btn');
        const closeShopBtn = document.getElementById('close-shop-btn');
        const closeTrophyRoadBtn = document.getElementById('close-trophy-road-btn');
        const closeEventsBtn = document.getElementById('close-events-btn');
        const closeApplePassBtn = document.getElementById('close-apple-pass-btn');
        
        const caseRewardStep1 = document.getElementById('case-reward-step-1');
        const caseRewardStep2 = document.getElementById('case-reward-step-2');
        const caseMoneyRewardElement = document.getElementById('case-money-reward');
        const remainingItemsElement = document.getElementById('remaining-items');
        const caseCharacterIconElement = document.getElementById('case-character-icon');
        const caseCharacterTextElement = document.getElementById('case-character-text');
        
        const mysteriousChestRewardStep1 = document.getElementById('mysterious-chest-reward-step-1');
        const mysteriousChestRewardStep2 = document.getElementById('mysterious-chest-reward-step-2');
        const mysteriousChestMoneyRewardElement = document.getElementById('mysterious-chest-money-reward');
        const mysteriousChestRemainingItemsElement = document.getElementById('mysterious-chest-remaining-items');
        const mysteriousChestCharacterIconElement = document.getElementById('mysterious-chest-character-icon');
        const mysteriousChestCharacterTextElement = document.getElementById('mysterious-chest-character-text');

        const promoCodeInput = document.getElementById('promo-code-input');
        const usePromoBtn = document.getElementById('use-promo-btn');
        const promoMessage = document.getElementById('promo-message');

        const characterTabs = document.querySelectorAll('.character-tab');

        const timerCountdownElement = document.getElementById('timer-countdown');
        const newYearTimerElement = document.getElementById('new-year-timer');
        const caseOpeningTitleElement = document.getElementById('case-opening-title');

        const floatingFragmentsElement = document.getElementById('floating-fragments');

        // === PATCH: НОВАЯ ФУНКЦИЯ ДЛЯ ОТКРЫТИЯ КЕЙСОВ ИЗ APPLE PASS ===
        function openCaseFromReward(caseType, amount) {
            // Устанавливаем флаг, что открываем из Apple Pass
            openingCaseFromApplePass = true;
            
            // Устанавливаем количество предметов
            gameData.caseItems = amount;
            
            // Определяем тип кейса
            let caseImage, caseTitle;
            
            switch(caseType) {
                case 'rift':
                    caseImage = 'https://i.ibb.co/4ZBgCqK/rift-case.png';
                    caseTitle = 'Откройте Кейс "Разлом"!';
                    break;
                case 'anomaly':
                    caseImage = 'https://i.ibb.co/0jQz8ZR/anomaly-case.png';
                    caseTitle = 'Откройте Кейс "Аномалия"!';
                    break;
                default:
                    caseImage = 'https://i.ibb.co/f7nMj9c/Picsart-25-12-09-23-02-46-736.png';
                    caseTitle = 'Откройте Яблочный Кейс!';
            }
            
            // Настраиваем интерфейс
            caseOpeningTitleElement.textContent = caseTitle;
            appleCaseElement.style.backgroundImage = `url('${caseImage}')`;
            
            // Показываем экран открытия кейса
            applePassSectionElement.classList.remove('active');
            caseOpeningElement.style.display = 'flex';
            playBtn.style.display = 'none';
            eventsBtn.style.display = 'none';
            
            // Сбрасываем состояние кейса
            resetCaseState();
            
            // Показываем кейс и запускаем анимацию
            appleCaseElement.style.display = 'flex';
            caseCountElement.textContent = `Предметов: ${gameData.caseItems}`;
            closeCaseBtn.style.display = 'none';
            
            setTimeout(() => {
                caseHintElement.style.opacity = '1';
                caseHintElement.style.transition = 'opacity 0.5s';
                appleCaseElement.classList.add('case-shake');
            }, 1000);
        }

        // === PATCH: ИСПРАВЛЕННАЯ ФУНКЦИЯ ДЛЯ ОТКРЫТИЯ ТАИНСТВЕННОГО ЯЩИКА ===
        function openMysteriousChestFromReward(amount) {
            openingCaseFromTrophyRoad = true;
            gameData.chestsToOpen = amount;
            openMysteriousChest();
        }

        // === PATCH: ИСПРАВЛЕННАЯ ФУНКЦИЯ ДЛЯ СБРОСА СОСТОЯНИЯ КЕЙСА ===
        function resetCaseState() {
            isOpeningCase = false;
            gameData.caseAnimationInProgress = false;
            gameData.currentCaseRewards = [];
            gameData.currentCaseStep = 0;
            
            appleCaseElement.classList.remove('case-disabled', 'case-opening-animation', 'case-shake');
            appleCaseElement.style.display = 'flex';
            caseRewardStep1.style.display = 'none';
            caseRewardStep1.classList.remove('active');
            caseRewardStep2.style.display = 'none';
            caseRewardStep2.classList.remove('active');
            closeCaseBtn.style.display = 'none';
            caseHintElement.style.opacity = '0';
        }

        // === PATCH: ИСПРАВЛЕННАЯ ФУНКЦИЯ ДЛЯ СБРОСА СОСТОЯНИЯ ТАИНСТВЕННОГО ЯЩИКА ===
        function resetMysteriousChestState() {
            gameData.mysteriousChestAnimationInProgress = false;
            gameData.currentMysteriousChestRewards = [];
            gameData.currentMysteriousChestStep = 0;
            gameData.chestTaps = 0;
            gameData.chestOpening = false;
            
            mysteriousChestElement.classList.remove('case-disabled', 'chest-open-animation');
            mysteriousChestElement.style.display = 'flex';
            mysteriousChestRewardStep1.style.display = 'none';
            mysteriousChestRewardStep1.classList.remove('active');
            mysteriousChestRewardStep2.style.display = 'none';
            mysteriousChestRewardStep2.classList.remove('active');
            closeChestBtn.style.display = 'none';
            
            [chestCrack1, chestCrack2, chestCrack3, chestCrack4, chestCrack5].forEach(crack => {
                crack.style.opacity = '0';
            });
            
            chestTapCounterElement.textContent = `Нажмите на ящик: 0/5`;
        }

        // === PATCH: ИСПРАВЛЕННАЯ ФУНКЦИЯ ОТКРЫТИЯ КЕЙСА ===
        function openCase(caseType) {
            if (isOpeningCase || gameData.caseAnimationInProgress) return;
            
            isOpeningCase = true;
            gameData.caseAnimationInProgress = true;
            
            // Блокируем клики
            appleCaseElement.classList.add('case-disabled', 'case-opening-animation');
            
            // Убираем анимацию тряски
            appleCaseElement.classList.remove('case-shake');
            
            // Через 1.5 секунды показываем награды
            setTimeout(() => {
                try {
                    appleCaseElement.style.display = 'none';
                    
                    if (caseType === 'anomaly') {
                        giveAnomalyCaseReward();
                    } else if (caseType === 'rift') {
                        giveRiftCaseReward();
                    } else if (caseType === 'standard') {
                        showCaseRewards();
                    } else if (caseType === 'newyear') {
                        showCaseRewards(); // Новогодний кейс использует стандартные награды
                    }
                } catch (e) {
                    console.error('Ошибка при открытии кейса:', e);
                    finishCaseOpening();
                }
            }, 1500);
        }

        // === PATCH: ИСПРАВЛЕННАЯ ФУНКЦИЯ ЗАВЕРШЕНИЯ ОТКРЫТИЯ КЕЙСА ===
        function finishCaseOpening() {
            isOpeningCase = false;
            gameData.caseAnimationInProgress = false;
            
            // Сбрасываем состояние
            resetCaseState();
            
            // Если открывали из Apple Pass, возвращаемся в главное меню
            if (openingCaseFromApplePass) {
                openingCaseFromApplePass = false;
                caseOpeningElement.style.display = 'none';
                showSection('main');
            }
            // Если открывали из магазина, возвращаемся в магазин
            else {
                caseOpeningElement.style.display = 'none';
                showSection('shop');
            }
        }

        // === PATCH: ИСПРАВЛЕННАЯ ФУНКЦИЯ ЗАКРЫТИЯ КЕЙСА ===
        function handleCloseCase() {
            finishCaseOpening();
        }

        // === PATCH: ИСПРАВЛЕННАЯ ФУНКЦИЯ ДЛЯ ТАИНСТВЕННОГО ЯЩИКА ===
        function tapMysteriousChest() {
            if (gameData.mysteriousChestAnimationInProgress || gameData.chestTaps >= 5) return;
            
            gameData.chestTaps++;
            chestTapCounterElement.textContent = `Нажмите на ящик: ${gameData.chestTaps}/5`;
            
            // Показываем трещины
            if (gameData.chestTaps === 1) chestCrack1.style.opacity = '1';
            if (gameData.chestTaps === 2) chestCrack2.style.opacity = '1';
            if (gameData.chestTaps === 3) chestCrack3.style.opacity = '1';
            if (gameData.chestTaps === 4) chestCrack4.style.opacity = '1';
            if (gameData.chestTaps === 5) chestCrack5.style.opacity = '1';
            
            // Анимация при нажатии
            const scale = 1 + (gameData.chestTaps * 0.05);
            mysteriousChestElement.style.transform = `scale(${scale})`;
            
            // Если достигли максимума, открываем ящик
            if (gameData.chestTaps >= 5) {
                gameData.mysteriousChestAnimationInProgress = true;
                mysteriousChestElement.classList.add('case-disabled');
                
                mysteriousChestElement.classList.add('chest-open-animation');
                
                setTimeout(() => {
                    mysteriousChestElement.style.display = 'none';
                    showMysteriousChestReward();
                }, 1000);
            }
        }

        // === ОСТАЛЬНЫЕ ФУНКЦИИ (без изменений) ===
        function dealDamage(amount) {
            const now = Date.now();
            if (now - lastDamageTime < DAMAGE_COOLDOWN) return;
            
            lastDamageTime = now;
            playerHealth -= amount;
            
            if (playerHealth < 0) playerHealth = 0;
            
            updateHealthUI();
            
            if (playerHealth <= 0) {
                playerDeath();
            }
        }

        function updateHealthUI() {
            const percent = (playerHealth / maxHealth) * 100;
            const bar = document.querySelector('.health-fill');
            const text = document.querySelector('.health-text');
            
            if (bar) bar.style.width = percent + '%';
            if (text) text.textContent = `${playerHealth} / ${maxHealth}`;
        }

        function playerDeath() {
            if (survivalGameInstance && survivalGameInstance.gameActive) {
                survivalGameInstance.lose();
            }
            if (realityRiftGameInstance && realityRiftGameInstance.gameActive) {
                realityRiftGameInstance.lose();
            }
        }

        class SurvivalGame {
            constructor() {
                this.timeLeft = 120;
                this.playerHP = 5000;
                this.maxHP = 5000;
                this.playerPosition = { x: 400, y: 300 };
                this.enemyPosition = { x: 200, y: 200 };
                this.bullets = [];
                this.miniApples = [];
                this.gameActive = false;
                this.lastHitTime = 0;
                this.attackPhase = "red_apple_shooting";
                this.phaseTimer = 0;
                this.gameLoop = null;
                this.lastUpdateTime = 0;
                
                this.joystickActive = false;
                this.joystickPosition = { x: 120, y: window.innerHeight - 120 };
                this.joystickBaseRadius = 75;
                this.joystickHandleRadius = 30;
                this.joystickVector = { x: 0, y: 0 };
                this.joystickHandlePosition = { x: 0, y: 0 };
                
                this.playerElement = null;
                this.enemyElement = null;
                
                this.handleJoystickStart = this.handleJoystickStart.bind(this);
                this.handleJoystickMove = this.handleJoystickMove.bind(this);
                this.handleJoystickEnd = this.handleJoystickEnd.bind(this);
            }
            
            init() {
                this.createGameElements();
                this.setupJoystick();
                this.startGame();
            }
            
            createGameElements() {
                survivalGameAreaElement.innerHTML = '';
                
                this.playerElement = document.createElement('div');
                this.playerElement.className = 'survival-player';
                this.playerElement.id = 'survival-player';
                this.playerElement.style.left = `${this.playerPosition.x}px`;
                this.playerElement.style.top = `${this.playerPosition.y}px`;
                survivalGameAreaElement.appendChild(this.playerElement);
                
                this.enemyElement = document.createElement('div');
                this.enemyElement.className = 'survival-enemy';
                this.enemyElement.id = 'survival-enemy';
                this.enemyElement.style.left = `${this.enemyPosition.x}px`;
                this.enemyElement.style.top = `${this.enemyPosition.y}px`;
                survivalGameAreaElement.appendChild(this.enemyElement);
                
                this.createMiniApples();
            }
            
            createMiniApples() {
                this.miniApples = [];
                const count = Math.floor(Math.random() * 3) + 4;
                
                for (let i = 0; i < count; i++) {
                    const miniApple = {
                        element: null,
                        position: { x: 0, y: 0 },
                        bullets: [],
                        lastShot: 0
                    };
                    
                    if (i % 2 === 0) {
                        miniApple.position.x = Math.random() * 100 + 50;
                    } else {
                        miniApple.position.x = window.innerWidth - Math.random() * 100 - 150;
                    }
                    miniApple.position.y = Math.random() * (window.innerHeight - 200) + 100;
                    
                    const element = document.createElement('div');
                    element.className = 'mini-apple';
                    element.style.left = `${miniApple.position.x}px`;
                    element.style.top = `${miniApple.position.y}px`;
                    survivalGameAreaElement.appendChild(element);
                    
                    miniApple.element = element;
                    this.miniApples.push(miniApple);
                }
            }
            
            setupJoystick() {
                joystickHandleElement.addEventListener('mousedown', this.handleJoystickStart);
                joystickHandleElement.addEventListener('touchstart', this.handleJoystickStart);
                
                document.addEventListener('mousemove', this.handleJoystickMove);
                document.addEventListener('touchmove', this.handleJoystickMove);
                
                document.addEventListener('mouseup', this.handleJoystickEnd);
                document.addEventListener('touchend', this.handleJoystickEnd);
            }
            
            handleJoystickStart(e) {
                e.preventDefault();
                this.joystickActive = true;
                this.updateJoystickPosition(e);
            }
            
            handleJoystickMove(e) {
                if (!this.joystickActive) return;
                e.preventDefault();
                this.updateJoystickPosition(e);
            }
            
            handleJoystickEnd(e) {
                if (!this.joystickActive) return;
                e.preventDefault();
                this.joystickActive = false;
                
                this.joystickVector = { x: 0, y: 0 };
                this.joystickHandlePosition = { x: 0, y: 0 };
                joystickHandleElement.style.transform = 'translate(-50%, -50%)';
            }
            
            updateJoystickPosition(e) {
                const rect = joystickContainerElement.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;
                
                let clientX, clientY;
                
                if (e.type.includes('touch')) {
                    clientX = e.touches[0].clientX;
                    clientY = e.touches[0].clientY;
                } else {
                    clientX = e.clientX;
                    clientY = e.clientY;
                }
                
                let deltaX = clientX - centerX;
                let deltaY = clientY - centerY;
                
                const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
                const maxDistance = this.joystickBaseRadius - this.joystickHandleRadius;
                
                if (distance > maxDistance) {
                    deltaX = (deltaX / distance) * maxDistance;
                    deltaY = (deltaY / distance) * maxDistance;
                }
                
                this.joystickHandlePosition = { x: deltaX, y: deltaY };
                joystickHandleElement.style.transform = `translate(${deltaX}px, ${deltaY}px)`;
                
                this.joystickVector = {
                    x: deltaX / maxDistance,
                    y: deltaY / maxDistance
                };
            }
            
            startGame() {
                this.gameActive = true;
                this.lastUpdateTime = Date.now();
                this.gameLoop = requestAnimationFrame(this.update.bind(this));
                
                this.startAttackPhase();
            }
            
            startAttackPhase() {
                this.attackPhase = "red_apple_shooting";
                this.phaseTimer = 10;
            }
            
            update() {
                if (!this.gameActive) return;
                
                const currentTime = Date.now();
                const deltaTime = (currentTime - this.lastUpdateTime) / 1000;
                this.lastUpdateTime = currentTime;
                
                this.timeLeft -= deltaTime;
                this.updateTimerDisplay();
                
                this.updateAttackPhase(deltaTime);
                
                this.updatePlayerMovement(deltaTime);
                
                this.updateEnemyMovement(deltaTime);
                
                this.updateBullets(deltaTime);
                
                this.updateMiniApples(deltaTime);
                
                this.checkCollisions();
                
                this.updateRegeneration(deltaTime);
                
                if (this.timeLeft <= 0) {
                    this.win();
                    return;
                }
                
                if (this.playerHP <= 0) {
                    this.lose();
                    return;
                }
                
                this.gameLoop = requestAnimationFrame(this.update.bind(this));
            }
            
            updateTimerDisplay() {
                const minutes = Math.floor(this.timeLeft / 60);
                const seconds = Math.floor(this.timeLeft % 60);
                survivalTimerElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
            
            updateAttackPhase(deltaTime) {
                this.phaseTimer -= deltaTime;
                
                if (this.phaseTimer <= 0) {
                    switch (this.attackPhase) {
                        case "red_apple_shooting":
                            this.attackPhase = "mini_apples";
                            this.phaseTimer = 5;
                            this.startMiniAppleAttack();
                            break;
                            
                        case "mini_apples":
                            this.attackPhase = "red_apple_direct";
                            this.phaseTimer = 5;
                            break;
                            
                        case "red_apple_direct":
                            this.startAttackPhase();
                            break;
                    }
                }
                
                if (this.attackPhase === "red_apple_shooting" || this.attackPhase === "red_apple_direct") {
                    this.enemyShoot(deltaTime);
                }
            }
            
            startMiniAppleAttack() {
                this.miniApples.forEach(miniApple => {
                    miniApple.lastShot = 0;
                });
            }
            
            enemyShoot(deltaTime) {
                const shootInterval = this.attackPhase === "red_apple_direct" ? 0.3 : 0.8;
                
                if (Math.random() < deltaTime / shootInterval) {
                    this.createBullet(this.enemyPosition, this.playerPosition, 300, "enemy");
                }
            }
            
            createBullet(from, to, speed, type) {
                const dx = to.x - from.x;
                const dy = to.y - from.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                const bullet = {
                    element: null,
                    position: { x: from.x, y: from.y },
                    velocity: {
                        x: (dx / distance) * speed,
                        y: (dy / distance) * speed
                    },
                    type: type
                };
                
                const element = document.createElement('div');
                element.className = 'bullet';
                element.style.left = `${bullet.position.x}px`;
                element.style.top = `${bullet.position.y}px`;
                survivalGameAreaElement.appendChild(element);
                
                bullet.element = element;
                this.bullets.push(bullet);
            }
            
            updatePlayerMovement(deltaTime) {
                if (!this.joystickActive) return;
                
                const speed = 200 * Math.sqrt(this.joystickVector.x ** 2 + this.joystickVector.y ** 2);
                
                this.playerPosition.x += this.joystickVector.x * speed * deltaTime;
                this.playerPosition.y += this.joystickVector.y * speed * deltaTime;
                
                this.playerPosition.x = Math.max(30, Math.min(window.innerWidth - 90, this.playerPosition.x));
                this.playerPosition.y = Math.max(30, Math.min(window.innerHeight - 150, this.playerPosition.y));
                
                this.playerElement.style.left = `${this.playerPosition.x}px`;
                this.playerElement.style.top = `${this.playerPosition.y}px`;
            }
            
            updateEnemyMovement(deltaTime) {
                const dx = this.playerPosition.x - this.enemyPosition.x;
                const dy = this.playerPosition.y - this.enemyPosition.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance > 100) {
                    const speed = 80;
                    this.enemyPosition.x += (dx / distance) * speed * deltaTime;
                    this.enemyPosition.y += (dy / distance) * speed * deltaTime;
                }
                
                this.enemyElement.style.left = `${this.enemyPosition.x}px`;
                this.enemyElement.style.top = `${this.enemyPosition.y}px`;
            }
            
            updateMiniApples(deltaTime) {
                if (this.attackPhase !== "mini_apples") return;
                
                this.miniApples.forEach(miniApple => {
                    miniApple.lastShot += deltaTime;
                    
                    if (miniApple.lastShot > 0.2) {
                        this.createBullet(miniApple.position, this.playerPosition, 400, "mini_apple");
                        miniApple.lastShot = 0;
                    }
                });
            }
            
            updateBullets(deltaTime) {
                for (let i = this.bullets.length - 1; i >= 0; i--) {
                    const bullet = this.bullets[i];
                    
                    bullet.position.x += bullet.velocity.x * deltaTime;
                    bullet.position.y += bullet.velocity.y * deltaTime;
                    
                    if (bullet.position.x < -50 || bullet.position.x > window.innerWidth + 50 ||
                        bullet.position.y < -50 || bullet.position.y > window.innerHeight + 50) {
                        if (bullet.element.parentNode) {
                            bullet.element.parentNode.removeChild(bullet.element);
                        }
                        this.bullets.splice(i, 1);
                        continue;
                    }
                    
                    bullet.element.style.left = `${bullet.position.x}px`;
                    bullet.element.style.top = `${bullet.position.y}px`;
                }
            }
            
            checkCollisions() {
                for (let i = this.bullets.length - 1; i >= 0; i--) {
                    const bullet = this.bullets[i];
                    
                    const dx = bullet.position.x - this.playerPosition.x;
                    const dy = bullet.position.y - this.playerPosition.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance < 40) {
                        const damage = bullet.type === "enemy" ? 700 : 300;
                        this.takeDamage(damage);
                        
                        if (bullet.element.parentNode) {
                            bullet.element.parentNode.removeChild(bullet.element);
                        }
                        this.bullets.splice(i, 1);
                    }
                }
            }
            
            takeDamage(damage) {
                const timeSinceLastHit = (Date.now() / 1000) - this.lastHitTime;
                
                if (timeSinceLastHit > 5 || this.lastHitTime === 0) {
                    dealDamage(damage);
                    this.playerHP = playerHealth;
                    this.lastHitTime = Date.now() / 1000;
                    this.updateHealthDisplay();
                    
                    this.playerElement.style.boxShadow = '0 0 30px rgba(255, 0, 0, 1)';
                    setTimeout(() => {
                        if (this.playerElement) {
                            this.playerElement.style.boxShadow = '0 0 20px rgba(76, 175, 80, 0.5)';
                        }
                    }, 200);
                }
            }
            
            updateRegeneration(deltaTime) {
                const timeSinceLastHit = (Date.now() / 1000) - this.lastHitTime;
                
                if (timeSinceLastHit > 5 && this.playerHP < this.maxHP) {
                    this.playerHP = Math.min(this.maxHP, this.playerHP + 300 * deltaTime);
                    playerHealth = this.playerHP;
                    this.updateHealthDisplay();
                }
            }
            
            updateHealthDisplay() {
                const healthPercent = (this.playerHP / this.maxHP) * 100;
                survivalHealthFillElement.style.width = `${healthPercent}%`;
                survivalHealthTextElement.textContent = `${Math.floor(this.playerHP)}/${this.maxHP}`;
                
                if (healthPercent > 70) {
                    survivalHealthFillElement.style.background = 'linear-gradient(90deg, #00ff00, #00aa00)';
                } else if (healthPercent > 30) {
                    survivalHealthFillElement.style.background = 'linear-gradient(90deg, #ffff00, #ffaa00)';
                } else {
                    survivalHealthFillElement.style.background = 'linear-gradient(90deg, #ff0000, #aa0000)';
                }
            }
            
            win() {
                this.gameActive = false;
                cancelAnimationFrame(this.gameLoop);
                
                this.enemyElement.style.animation = 'chestOpen 1s forwards';
                
                setTimeout(() => {
                    gameData.crystals += 100;
                    gameData.survivalWins++;
                    
                    if (!gameData.characterTrophies[gameData.selectedCharacterId]) {
                        gameData.characterTrophies[gameData.selectedCharacterId] = 0;
                    }
                    gameData.characterTrophies[gameData.selectedCharacterId] += 50;
                    gameData.trophies += 50;
                    
                    if (this.timeLeft > gameData.survivalBestTime) {
                        gameData.survivalBestTime = Math.floor(120 - this.timeLeft);
                    }
                    
                    showNotification('ПОБЕДА!', 'Вы выжили 2 минуты, получили 100 кристаллов и 50 кубков!', 'crystals');
                    updateUI();
                    exitSurvivalGame();
                }, 1000);
            }
            
            lose() {
                this.gameActive = false;
                cancelAnimationFrame(this.gameLoop);
                
                this.playerElement.style.animation = 'chestOpen 1s forwards';
                
                setTimeout(() => {
                    showNotification('ПОРАЖЕНИЕ', 'Попробуйте еще раз!', 'trophies');
                    exitSurvivalGame();
                }, 1000);
            }
            
            cleanup() {
                joystickHandleElement.removeEventListener('mousedown', this.handleJoystickStart);
                joystickHandleElement.removeEventListener('touchstart', this.handleJoystickStart);
                document.removeEventListener('mousemove', this.handleJoystickMove);
                document.removeEventListener('touchmove', this.handleJoystickMove);
                document.removeEventListener('mouseup', this.handleJoystickEnd);
                document.removeEventListener('touchend', this.handleJoystickEnd);
                
                if (this.gameLoop) {
                    cancelAnimationFrame(this.gameLoop);
                }
            }
        }

        class RealityRiftGame extends SurvivalGame {
            constructor() {
                super();
                this.wave = 1;
                this.waveEnemies = 3;
                this.modifiers = [];
                this.enemies = [];
                this.timeLeft = 180;
            }
            
            init() {
                this.generateModifiers();
                this.createGameElements();
                this.setupJoystick();
                this.startGame();
            }
            
            generateModifiers() {
                this.modifiers = [];
                const possibleModifiers = [
                    { name: "Ускорение времени", effect: "timeSpeed", value: 1.5 },
                    { name: "Зеркальное управление", effect: "mirrorControls", value: true },
                    { name: "Двойной урон", effect: "doubleDamage", value: 2 },
                    { name: "Замедление врагов", effect: "enemySlow", value: 0.7 },
                    { name: "Быстрая регенерация", effect: "fastRegen", value: 2 }
                ];
                
                const numModifiers = Math.floor(Math.random() * 2) + 1;
                for (let i = 0; i < numModifiers; i++) {
                    const randomIndex = Math.floor(Math.random() * possibleModifiers.length);
                    this.modifiers.push(possibleModifiers[randomIndex]);
                }
                
                let modifierText = "Модификаторы: ";
                this.modifiers.forEach((mod, index) => {
                    modifierText += mod.name;
                    if (index < this.modifiers.length - 1) modifierText += ", ";
                });
                
                showNotification("РАЗЛОМ РЕАЛЬНОСТИ", modifierText, "fracture");
            }
            
            createGameElements() {
                survivalGameAreaElement.innerHTML = '';
                
                this.playerElement = document.createElement('div');
                this.playerElement.className = 'survival-player';
                this.playerElement.id = 'survival-player';
                this.playerElement.style.left = `${this.playerPosition.x}px`;
                this.playerElement.style.top = `${this.playerPosition.y}px`;
                survivalGameAreaElement.appendChild(this.playerElement);
                
                this.createWaveEnemies();
            }
            
            createWaveEnemies() {
                this.enemies = [];
                
                for (let i = 0; i < this.waveEnemies; i++) {
                    const enemy = {
                        element: null,
                        position: { x: 0, y: 0 },
                        hp: 1000,
                        maxHp: 1000,
                        speed: 60,
                        lastShot: 0
                    };
                    
                    enemy.position.x = Math.random() * (window.innerWidth - 100) + 50;
                    enemy.position.y = Math.random() * (window.innerHeight - 200) + 100;
                    
                    const element = document.createElement('div');
                    element.className = 'survival-enemy';
                    element.style.left = `${enemy.position.x}px`;
                    element.style.top = `${enemy.position.y}px`;
                    element.style.background = 'radial-gradient(circle, #8A2BE2, #4B0082)';
                    survivalGameAreaElement.appendChild(element);
                    
                    enemy.element = element;
                    this.enemies.push(enemy);
                }
            }
            
            update() {
                if (!this.gameActive) return;
                
                const currentTime = Date.now();
                let deltaTime = (currentTime - this.lastUpdateTime) / 1000;
                this.lastUpdateTime = currentTime;
                
                let actualDeltaTime = deltaTime;
                if (this.modifiers.find(m => m.effect === "timeSpeed")) {
                    actualDeltaTime *= 1.5;
                }
                
                this.timeLeft -= actualDeltaTime;
                this.updateTimerDisplay();
                
                this.updatePlayerMovement(actualDeltaTime);
                
                this.updateEnemies(actualDeltaTime);
                
                this.enemyShoot(actualDeltaTime);
                
                this.updateBullets(actualDeltaTime);
                
                this.checkCollisions();
                
                this.updateRegeneration(actualDeltaTime);
                
                if (this.enemies.length === 0) {
                    this.nextWave();
                }
                
                if (this.timeLeft <= 0) {
                    this.win();
                    return;
                }
                
                if (this.playerHP <= 0) {
                    this.lose();
                    return;
                }
                
                this.gameLoop = requestAnimationFrame(() => this.update(actualDeltaTime));
            }
            
            updateEnemies(deltaTime) {
                for (let i = this.enemies.length - 1; i >= 0; i--) {
                    const enemy = this.enemies[i];
                    
                    const dx = this.playerPosition.x - enemy.position.x;
                    const dy = this.playerPosition.y - enemy.position.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance > 50) {
                        let speed = enemy.speed;
                        if (this.modifiers.find(m => m.effect === "enemySlow")) {
                            speed *= 0.7;
                        }
                        
                        enemy.position.x += (dx / distance) * speed * deltaTime;
                        enemy.position.y += (dy / distance) * speed * deltaTime;
                    }
                    
                    enemy.element.style.left = `${enemy.position.x}px`;
                    enemy.element.style.top = `${enemy.position.y}px`;
                }
            }
            
            enemyShoot(deltaTime) {
                this.enemies.forEach(enemy => {
                    enemy.lastShot += deltaTime;
                    
                    if (enemy.lastShot > 1) {
                        this.createBullet(enemy.position, this.playerPosition, 200, "enemy");
                        enemy.lastShot = 0;
                    }
                });
            }
            
            checkCollisions() {
                super.checkCollisions();
                
                for (let i = this.bullets.length - 1; i >= 0; i--) {
                    const bullet = this.bullets[i];
                    
                    if (bullet.type === "player") {
                        for (let j = this.enemies.length - 1; j >= 0; j--) {
                            const enemy = this.enemies[j];
                            
                            const dx = bullet.position.x - enemy.position.x;
                            const dy = bullet.position.y - enemy.position.y;
                            const distance = Math.sqrt(dx * dx + dy * dy);
                            
                            if (distance < 45) {
                                let damage = 100;
                                if (this.modifiers.find(m => m.effect === "doubleDamage")) {
                                    damage *= 2;
                                }
                                
                                enemy.hp -= damage;
                                
                                enemy.element.style.boxShadow = '0 0 20px rgba(255, 0, 0, 1)';
                                setTimeout(() => {
                                    if (enemy.element) {
                                        enemy.element.style.boxShadow = '0 0 25px rgba(255, 0, 0, 0.7)';
                                    }
                                }, 200);
                                
                                if (bullet.element.parentNode) {
                                    bullet.element.parentNode.removeChild(bullet.element);
                                }
                                this.bullets.splice(i, 1);
                                
                                if (enemy.hp <= 0) {
                                    if (enemy.element.parentNode) {
                                        enemy.element.parentNode.removeChild(enemy.element);
                                    }
                                    this.enemies.splice(j, 1);
                                }
                                
                                break;
                            }
                        }
                    }
                }
            }
            
            updateRegeneration(deltaTime) {
                let regenRate = 300;
                if (this.modifiers.find(m => m.effect === "fastRegen")) {
                    regenRate *= 2;
                }
                
                const timeSinceLastHit = (Date.now() / 1000) - this.lastHitTime;
                
                if (timeSinceLastHit > 5 && this.playerHP < this.maxHP) {
                    this.playerHP = Math.min(this.maxHP, this.playerHP + regenRate * deltaTime);
                    playerHealth = this.playerHP;
                    this.updateHealthDisplay();
                }
            }
            
            nextWave() {
                this.wave++;
                this.waveEnemies = Math.min(10, this.waveEnemies + 1);
                
                gameData.fractureEnergy += this.wave * 10;
                gameData.season22Data.applePass22Points += 50;
                
                showNotification(`Волна ${this.wave} пройдена!`, `+${this.wave * 10} энергии разлома`, 'fracture');
                
                this.createWaveEnemies();
                
                updateUI();
                renderApplePass22Rewards();
            }
            
            win() {
                this.gameActive = false;
                cancelAnimationFrame(this.gameLoop);
                
                const energyReward = this.wave * 50 + 200;
                const crystalsReward = 100 + this.wave * 20;
                const trophyReward = this.wave * 10 + 50;
                
                gameData.fractureEnergy += energyReward;
                gameData.crystals += crystalsReward;
                gameData.trophies += trophyReward;
                gameData.season22Data.realityRiftWins++;
                gameData.season22Data.applePass22Points += 200;
                
                if (!gameData.characterTrophies[gameData.selectedCharacterId]) {
                    gameData.characterTrophies[gameData.selectedCharacterId] = 0;
                }
                gameData.characterTrophies[gameData.selectedCharacterId] += trophyReward;
                
                if (Math.random() < 0.3) {
                    gameData.season22Data.anomalyCasesOpened++;
                    showNotification('РАЗЛОМ РЕАЛЬНОСТИ ПОБЕЖДЁН!', 
                        `+${trophyReward} кубков, +${energyReward} энергии, +${crystalsReward} кристаллов, +1 кейс!`, 'trophies');
                } else {
                    showNotification('РАЗЛОМ РЕАЛЬНОСТИ ПОБЕЖДЁН!', 
                        `+${trophyReward} кубков, +${energyReward} энергии, +${crystalsReward} кристаллов!`, 'trophies');
                }
                
                updateUI();
                renderApplePass22Rewards();
                exitSurvivalGame();
            }
            
            lose() {
                this.gameActive = false;
                cancelAnimationFrame(this.gameLoop);
                
                const energyReward = Math.floor(this.wave * 10);
                gameData.fractureEnergy += energyReward;
                gameData.season22Data.applePass22Points += 50;
                
                showNotification('ПОРАЖЕНИЕ В РАЗЛОМЕ', 
                    `Вы дошли до волны ${this.wave}. +${energyReward} энергии разлома`, 'fracture');
                
                updateUI();
                renderApplePass22Rewards();
                exitSurvivalGame();
            }
            
            takeDamage(damage) {
                const timeSinceLastHit = (Date.now() / 1000) - this.lastHitTime;
                
                if (timeSinceLastHit > 5 || this.lastHitTime === 0) {
                    dealDamage(damage);
                    this.playerHP = playerHealth;
                    this.lastHitTime = Date.now() / 1000;
                    this.updateHealthDisplay();
                    
                    this.playerElement.style.boxShadow = '0 0 30px rgba(255, 0, 0, 1)';
                    setTimeout(() => {
                        if (this.playerElement) {
                            this.playerElement.style.boxShadow = '0 0 20px rgba(76, 175, 80, 0.5)';
                        }
                    }, 200);
                }
            }
        }

        let survivalGameInstance = null;
        let realityRiftGameInstance = null;

        function giveAnomalyCaseReward() {
            gameData.currentCaseRewards = [];
            
            anomalyCaseCounter++;
            
            let hasGuaranteedAnomaly = false;
            if (anomalyCaseCounter >= ANOMALY_GUARANTEE) {
                hasGuaranteedAnomaly = true;
                anomalyCaseCounter = 0;
            }
            
            const random = Math.random() * 100;
            let cumulativeChance = 0;
            let selectedReward = null;
            
            for (const [rewardType, chance] of Object.entries(ANOMALY_CASE_CHANCES)) {
                cumulativeChance += chance;
                if (random <= cumulativeChance) {
                    selectedReward = rewardType;
                    break;
                }
            }
            
            if (hasGuaranteedAnomaly) {
                selectedReward = "anomaly_character";
            }
            
            if (selectedReward === "money") {
                const moneyReward = Math.floor(Math.random() * 2001) + 1000;
                gameData.currentCaseRewards.push({
                    type: 'money',
                    value: moneyReward
                });
            }
            else if (selectedReward.includes("character")) {
                let character = null;
                
                if (selectedReward === "anomaly_character") {
                    character = getRandomAnomalyCharacter();
                } else {
                    const rarityMap = {
                        "common_character": "common",
                        "rare_character": "rare",
                        "epic_character": "epic",
                        "legendary_character": "legendary",
                        "mythic_character": "mythic"
                    };
                    
                    const availableCharacters = charactersData.filter(char => 
                        char.rarity === rarityMap[selectedReward] && 
                        !gameData.unlockedCharacters.includes(char.id)
                    );
                    
                    if (availableCharacters.length > 0) {
                        const randomIndex = Math.floor(Math.random() * availableCharacters.length);
                        character = availableCharacters[randomIndex];
                    }
                }
                
                if (character) {
                    gameData.currentCaseRewards.push({
                        type: 'character',
                        character: character
                    });
                    
                    if (character.id === 27 || character.id === 28) {
                        gameData.season22Data.anomalyCharactersUnlocked.push(character.id);
                    }
                } else {
                    const moneyReward = Math.floor(Math.random() * 3001) + 2000;
                    gameData.currentCaseRewards.push({
                        type: 'money',
                        value: moneyReward
                    });
                }
            }
            
            gameData.currentCaseStep = 0;
            showNextCaseReward();
        }

        function giveRiftCaseReward() {
            gameData.currentCaseRewards = [];
            
            const energyReward = Math.floor(Math.random() * 51) + 50;
            gameData.currentCaseRewards.push({
                type: 'fracture_energy',
                value: energyReward
            });
            
            if (Math.random() < 0.6) {
                const fractureCharacter = getRandomFractureCharacter();
                if (fractureCharacter) {
                    gameData.currentCaseRewards.push({
                        type: 'character',
                        character: fractureCharacter
                    });
                    
                    if (!gameData.season22Data.fractureCharactersUnlocked.includes(fractureCharacter.id)) {
                        gameData.season22Data.fractureCharactersUnlocked.push(fractureCharacter.id);
                    }
                }
            }
            
            gameData.currentCaseStep = 0;
            showNextCaseReward();
        }

        function showNextCaseReward() {
            if (gameData.currentCaseStep >= gameData.currentCaseRewards.length) {
                closeCaseBtn.style.display = 'block';
                finishCaseOpening();
                return;
            }
            
            const reward = gameData.currentCaseRewards[gameData.currentCaseStep];
            
            if (reward.type === 'money') {
                caseMoneyRewardElement.textContent = `F-BUCKS: +${reward.value}`;
                caseRewardStep1.style.display = 'flex';
                caseRewardStep1.classList.add('active');
                caseRewardStep2.style.display = 'none';
                caseRewardStep2.classList.remove('active');
                
                gameData.balance += reward.value;
                updateUI();
                
            } else if (reward.type === 'character') {
                const isNew = !gameData.unlockedCharacters.includes(reward.character.id);
                
                if (isNew) {
                    caseCharacterIconElement.innerHTML = reward.character.icon;
                    caseCharacterTextElement.textContent = `НОВЫЙ ПЕРСОНАЖ: ${reward.character.name}`;
                    
                    gameData.unlockedCharacters.push(reward.character.id);
                    renderCharacters();
                    updateCharacterLobbyIcon();
                    
                    caseRewardStep1.style.display = 'none';
                    caseRewardStep1.classList.remove('active');
                    caseRewardStep2.style.display = 'flex';
                    caseRewardStep2.classList.add('active');
                } else {
                    gameData.currentCaseStep++;
                    showNextCaseReward();
                    return;
                }
            } else if (reward.type === 'fracture_energy') {
                caseMoneyRewardElement.textContent = `Энергия разлома: +${reward.value}`;
                caseRewardStep1.style.display = 'flex';
                caseRewardStep1.classList.add('active');
                caseRewardStep2.style.display = 'none';
                caseRewardStep2.classList.remove('active');
                
                gameData.fractureEnergy += reward.value;
                updateUI();
            }
            
            const remaining = gameData.currentCaseRewards.length - gameData.currentCaseStep - 1;
            remainingItemsElement.textContent = `Осталось предметов: ${remaining}`;
        }

        function nextCaseRewardStep() {
            gameData.currentCaseStep++;
            showNextCaseReward();
        }

        function showCaseRewards() {
            gameData.currentCaseRewards = [];
            
            const moneyReward = Math.floor(Math.random() * 401) + 100;
            gameData.currentCaseRewards.push({
                type: 'money',
                value: moneyReward
            });
            
            if (gameData.caseItems === 2) {
                const character = getRandomCharacter();
                if (character) {
                    gameData.currentCaseRewards.push({
                        type: 'character',
                        character: character
                    });
                }
            }
            
            gameData.currentCaseStep = 0;
            showNextCaseReward();
        }

        function showMysteriousChestReward() {
            gameData.currentMysteriousChestRewards = [];
            
            const moneyReward = Math.floor(Math.random() * 1001) + 500;
            gameData.currentMysteriousChestRewards.push({
                type: 'money',
                value: moneyReward
            });
            
            if (Math.random() < 0.7) {
                const trophyCharacter = getRandomTrophyCharacter();
                if (trophyCharacter) {
                    gameData.currentMysteriousChestRewards.push({
                        type: 'character',
                        character: trophyCharacter
                    });
                }
            }
            
            gameData.currentMysteriousChestStep = 0;
            showNextMysteriousChestReward();
        }

        function initGame() {
            const savedData = localStorage.getItem('appleRebirthGame');
            if (savedData) {
                const parsedData = JSON.parse(savedData);
                gameData = { ...gameData, ...parsedData };
                
                if (gameData.skullCharacterUnlocked && !gameData.unlockedCharacters.includes(21)) {
                    gameData.unlockedCharacters.push(21);
                }
                
                if (!gameData.season22Data) {
                    gameData.season22Data = {
                        anomalyCasesOpened: 0,
                        riftCasesOpened: 0,
                        realityRiftWins: 0,
                        anomalyCharactersUnlocked: [],
                        fractureCharactersUnlocked: [],
                        applePass22Points: 0,
                        applePass22Claimed: []
                    };
                }

                if (!gameData.characterTrophies) {
                    gameData.characterTrophies = {};
                }
                
                checkNewYearCaseAvailability();
            }

            gameData.characters = charactersData;

            checkTicketReset();
            
            updateUI();
            renderCharacters();
            updateCharacterLobbyIcon();
            updateTrophyRoad();
            renderApplePass22Rewards();
            updateNotificationBadges();
            updateSurvivalTicketsInfo();
            
            initFloatingFragments();
            updateNewYearTimer();
            setInterval(updateNewYearTimer, 1000);
            updateRealityRiftTicketsInfo();
            
            if (gameData.musicEnabled) {
                backgroundMusic.volume = 0.3;
                backgroundMusic.play().catch(e => console.log("Автовоспроизведение музыки заблокировано"));
            }
            
            setupEventListeners();
            
            preloadImages();
        }

        function initFloatingFragments() {
            const fragmentCount = 20;
            
            for (let i = 0; i < fragmentCount; i++) {
                const fragment = document.createElement('div');
                fragment.className = 'apple-fragment';
                
                const startX = Math.random() * window.innerWidth;
                const startY = Math.random() * window.innerHeight;
                
                fragment.style.left = `${startX}px`;
                fragment.style.top = `${startY}px`;
                
                const duration = 3 + Math.random() * 4;
                const delay = Math.random() * 2;
                
                fragment.style.animation = `
                    floatFragment ${duration}s ease-in-out ${delay}s infinite alternate
                `;
                
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes floatFragment {
                        0% {
                            transform: translate(0, 0) rotate(0deg);
                            opacity: ${0.3 + Math.random() * 0.3};
                        }
                        100% {
                            transform: translate(${Math.random() * 100 - 50}px, ${Math.random() * 100 - 50}px) rotate(360deg);
                            opacity: ${0.6 + Math.random() * 0.4};
                        }
                    }
                `;
                document.head.appendChild(style);
                
                floatingFragmentsElement.appendChild(fragment);
            }
        }
        
        function updateNewYearTimer() {
            const now = new Date();
            const mskNow = new Date(now.toLocaleString("en-US", {timeZone: "Europe/Moscow"}));
            
            if (mskNow >= NEW_YEAR_CASE_REMOVAL_DATE) {
                gameData.newYearCaseAvailable = false;
                if (newYearTimerElement) {
                    newYearTimerElement.innerHTML = `
                        <div class="timer-title">Новогодний кейс удалён!</div>
                        <div class="timer-countdown">Время вышло</div>
                    `;
                }
                if (buyNewYearCaseBtn) {
                    buyNewYearCaseBtn.disabled = true;
                    buyNewYearCaseBtn.textContent = "Недоступно";
                }
                return;
            }
            
            const timeLeft = NEW_YEAR_CASE_REMOVAL_DATE - mskNow;
            
            const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
            const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
            
            if (timerCountdownElement) {
                if (days > 0) {
                    timerCountdownElement.textContent = `${days}д ${hours}ч ${minutes}м`;
                } else {
                    timerCountdownElement.textContent = 
                        `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }
            }
        }
        
        function checkNewYearCaseAvailability() {
            const now = new Date();
            const mskNow = new Date(now.toLocaleString("en-US", {timeZone: "Europe/Moscow"}));
            gameData.newYearCaseAvailable = mskNow < NEW_YEAR_CASE_REMOVAL_DATE;
        }
        
        function updateRealityRiftTicketsInfo() {
            if (realityRiftTicketsInfoElement) {
                realityRiftTicketsInfoElement.textContent = `Требуется: 2 билета (осталось: ${gameData.tickets})`;
            }
            
            if (playRealityRiftBtn) {
                playRealityRiftBtn.disabled = gameData.tickets < 2;
            }
        }
        
        function getRandomAnomalyCharacter() {
            const availableAnomalyCharacters = charactersData.filter(char => 
                (char.id === 27 || char.id === 28) && 
                !gameData.season22Data.anomalyCharactersUnlocked.includes(char.id)
            );
            
            if (availableAnomalyCharacters.length === 0) {
                return null;
            }
            
            const randomIndex = Math.floor(Math.random() * availableAnomalyCharacters.length);
            return availableAnomalyCharacters[randomIndex];
        }
        
        function getRandomFractureCharacter() {
            const availableFractureCharacters = charactersData.filter(char => 
                char.id >= 22 && char.id <= 26 && 
                !gameData.unlockedCharacters.includes(char.id) &&
                !gameData.season22Data.fractureCharactersUnlocked.includes(char.id)
            );
            
            if (availableFractureCharacters.length === 0) {
                return null;
            }
            
            const weightedCharacters = [];
            availableFractureCharacters.forEach(char => {
                let weight = 1;
                switch(char.rarity) {
                    case "common": weight = 10; break;
                    case "rare": weight = 5; break;
                    case "epic": weight = 3; break;
                    case "legendary": weight = 1; break;
                    case "mythic": weight = 0.5; break;
                }
                
                for (let i = 0; i < weight; i++) {
                    weightedCharacters.push(char);
                }
            });
            
            const randomIndex = Math.floor(Math.random() * weightedCharacters.length);
            return weightedCharacters[randomIndex];
        }
        
        function renderApplePass22Rewards() {
            applePassRewardsElement.innerHTML = '';
            
            applePass22Rewards.forEach(rewardData => {
                const isClaimed = gameData.season22Data.applePass22Claimed.includes(rewardData.points);
                const isAvailable = gameData.season22Data.applePass22Points >= rewardData.points && !isClaimed;
                
                const rewardItem = document.createElement('div');
                rewardItem.className = `apple-pass-reward-item ${isClaimed ? 'claimed' : isAvailable ? 'available' : 'locked'}`;
                
                // === PATCH: ИСПРАВЛЕН ОБРАБОТЧИК КЛИКА ДЛЯ КЕЙСОВ ===
                if (isAvailable) {
                    if (rewardData.reward.type === 'rift_case' || rewardData.reward.type === 'anomaly_case') {
                        // Для кейсов открываем сразу, а не просто добавляем в инвентарь
                        rewardItem.addEventListener('click', () => claimAndOpenApplePassCase(rewardData));
                    } else {
                        rewardItem.addEventListener('click', () => claimApplePass22Reward(rewardData));
                    }
                }
                
                let iconClass = '';
                let iconContent = '';
                let rewardName = '';
                let rewardAmount = '';
                
                if (rewardData.reward.type === 'rift_case') {
                    iconClass = 'shop-item-icon rift-case-icon';
                    iconContent = '';
                    rewardName = 'Кейс "Разлом"';
                    rewardAmount = `×${rewardData.reward.amount}`;
                } else if (rewardData.reward.type === 'crystals') {
                    iconClass = 'crystal-icon-apple-pass';
                    iconContent = '💎';
                    rewardName = 'Кристаллы';
                    rewardAmount = `${rewardData.reward.amount}`;
                } else if (rewardData.reward.type === 'fracture_energy') {
                    iconClass = 'fas fa-bolt';
                    iconContent = '';
                    rewardName = 'Энергия разлома';
                    rewardAmount = `${rewardData.reward.amount}`;
                } else if (rewardData.reward.type === 'mysterious_chest') {
                    iconClass = 'mysterious-chest-icon';
                    iconContent = '';
                    rewardName = 'Таинственный ящик';
                    rewardAmount = `×${rewardData.reward.amount}`;
                } else if (rewardData.reward.type === 'anomaly_case') {
                    iconClass = 'shop-item-icon anomaly-case-icon';
                    iconContent = '';
                    rewardName = 'Кейс "Аномалия"';
                    rewardAmount = `×${rewardData.reward.amount}`;
                } else if (rewardData.reward.type === 'character') {
                    const character = charactersData.find(c => c.id === rewardData.reward.characterId);
                    if (character) {
                        iconContent = character.icon;
                        rewardName = character.name;
                        rewardAmount = 'Новый персонаж';
                    }
                } else if (rewardData.reward.type === 'legendary_character') {
                    const character = charactersData.find(c => c.id === rewardData.reward.characterId);
                    if (character) {
                        iconContent = character.icon;
                        rewardName = character.name;
                        rewardAmount = 'Легендарный персонаж!';
                    }
                }
                
                rewardItem.innerHTML = `
                    <div class="reward-apple-pass-points">${rewardData.points}</div>
                    <div class="reward-icon-apple-pass ${iconClass}">${iconContent}</div>
                    <div class="reward-name-apple-pass">${rewardName}</div>
                    <div class="reward-amount-apple-pass">${rewardAmount}</div>
                    ${isClaimed ? '<div style="color: #4CAF50; margin-top: 10px; font-weight: bold;">✓ ПОЛУЧЕНО</div>' : ''}
                `;
                
                applePassRewardsElement.appendChild(rewardItem);
            });
            
            updateNotificationBadges();
        }
        
        // === PATCH: НОВАЯ ФУНКЦИЯ ДЛЯ ОТКРЫТИЯ КЕЙСА ИЗ APPLE PASS ===
        function claimAndOpenApplePassCase(rewardData) {
            // Отмечаем награду как полученную
            gameData.season22Data.applePass22Claimed.push(rewardData.points);
            
            // Открываем кейс в зависимости от типа
            if (rewardData.reward.type === 'rift_case') {
                openCaseFromReward('rift', rewardData.reward.amount);
            } else if (rewardData.reward.type === 'anomaly_case') {
                openCaseFromReward('anomaly', rewardData.reward.amount);
            }
            
            // Обновляем интерфейс
            updateUI();
            renderApplePass22Rewards();
            saveGameData();
        }
        
        function claimApplePass22Reward(rewardData) {
            gameData.season22Data.applePass22Claimed.push(rewardData.points);
            
            if (rewardData.reward.type === 'crystals') {
                gameData.crystals += rewardData.reward.amount;
                showNotification(`+${rewardData.reward.amount} кристаллов`, 
                    `Вы получили награду Apple Pass 22!`, 'crystals');
            }
            else if (rewardData.reward.type === 'fracture_energy') {
                gameData.fractureEnergy += rewardData.reward.amount;
                showNotification(`+${rewardData.reward.amount} энергии разлома`, 
                    `Вы получили награду Apple Pass 22!`, 'fracture');
            }
            else if (rewardData.reward.type === 'mysterious_chest') {
                // Для таинственного ящика тоже сразу открываем
                openMysteriousChestFromReward(rewardData.reward.amount);
            }
            else if (rewardData.reward.type === 'character' || rewardData.reward.type === 'legendary_character') {
                const character = charactersData.find(c => c.id === rewardData.reward.characterId);
                if (character && !gameData.unlockedCharacters.includes(character.id)) {
                    gameData.unlockedCharacters.push(character.id);
                    gameData.season22Data.fractureCharactersUnlocked.push(character.id);
                    
                    showCharacterReveal(character);
                }
            }
            
            updateUI();
            renderApplePass22Rewards();
            saveGameData();
        }
        
        function startRealityRiftGame() {
            if (gameData.tickets < 2) {
                showNotification("Недостаточно билетов", "Нужно 2 билета для запуска Разлома Реальности", "tickets");
                return;
            }
            
            gameData.tickets -= 2;
            updateUI();
            updateRealityRiftTicketsInfo();
            
            eventsSectionElement.classList.remove('active');
            survivalGameElement.classList.add('active');
            
            if (survivalGameInstance) {
                survivalGameInstance.cleanup();
            }
            
            realityRiftGameInstance = new RealityRiftGame();
            realityRiftGameInstance.init();
            
            saveGameData();
        }
        
        function buyRiftCase() {
            if (gameData.fractureEnergy >= 50) {
                gameData.fractureEnergy -= 50;
                gameData.season22Data.riftCasesOpened++;
                
                gameData.caseItems = 1;
                
                shopSectionElement.classList.remove('active');
                caseOpeningElement.style.display = 'flex';
                playBtn.style.display = 'none';
                eventsBtn.style.display = 'none';
                
                caseOpeningTitleElement.textContent = 'Откройте Кейс "Разлом"!';
                appleCaseElement.style.backgroundImage = 'url(\'https://i.ibb.co/4ZBgCqK/rift-case.png\')';
                
                resetCaseState();
                appleCaseElement.style.display = 'flex';
                caseCountElement.textContent = `Предметов: ${gameData.caseItems}`;
                closeCaseBtn.style.display = 'none';
                
                setTimeout(() => {
                    caseHintElement.style.opacity = '1';
                    caseHintElement.style.transition = 'opacity 0.5s';
                    appleCaseElement.classList.add('case-shake');
                }, 1000);
                
                updateUI();
            } else {
                showNotification("Недостаточно энергии", "Нужно 50 энергии разлома для кейса", "fracture");
            }
        }
        
        function buyAnomalyCase() {
            if (gameData.crystals >= 500) {
                gameData.crystals -= 500;
                gameData.season22Data.anomalyCasesOpened++;
                
                gameData.caseItems = 1;
                
                shopSectionElement.classList.remove('active');
                caseOpeningElement.style.display = 'flex';
                playBtn.style.display = 'none';
                eventsBtn.style.display = 'none';
                
                caseOpeningTitleElement.textContent = 'Откройте Кейс "Аномалия"!';
                appleCaseElement.style.backgroundImage = 'url(\'https://i.ibb.co/0jQz8ZR/anomaly-case.png\')';
                
                resetCaseState();
                appleCaseElement.style.display = 'flex';
                caseCountElement.textContent = `Предметов: ${gameData.caseItems}`;
                closeCaseBtn.style.display = 'none';
                
                setTimeout(() => {
                    caseHintElement.style.opacity = '1';
                    caseHintElement.style.transition = 'opacity 0.5s';
                    appleCaseElement.classList.add('case-shake');
                }, 1000);
                
                updateUI();
            }
        }

        function buyExclusiveCharacter(charId) {
            if (gameData.crystals >= 100000) {
                gameData.crystals -= 100000;
                
                if (!gameData.unlockedCharacters.includes(charId)) {
                    gameData.unlockedCharacters.push(charId);
                }
                
                const char = gameData.characters.find(c => c.id === charId);
                showNotification('✨ НОВЫЙ ПЕРСОНАЖ!', 
                    `Вы разблокировали ${char.name}!\nОсталось кристаллов: ${gameData.crystals}`, 
                    'money');
                
                updateUI();
                saveGameData();
            } else {
                showNotification('⚠️ НЕ ХВАТАЕТ КРИСТАЛЛОВ', 
                    `Нужно 100,000 кристаллов, у вас ${gameData.crystals}`, 
                    'warning');
            }
        }

        function preloadImages() {
            const images = [
                'https://i.ibb.co/f7nMj9c/Picsart-25-12-09-23-02-46-736.png',
                'https://i.ibb.co/VXgrSKx/Picsart-25-12-09-23-02-22-635.png',
                'https://i.ibb.co/LXP8Z3Nw/f-bucks.png'
            ];
            
            let loadedCount = 0;
            const totalImages = images.length;
            
            images.forEach(src => {
                const img = new Image();
                img.src = src;
                img.onload = () => {
                    loadedCount++;
                    console.log(`Загружено изображение: ${src} (${loadedCount}/${totalImages})`);
                };
                img.onerror = () => {
                    console.log(`Ошибка загрузки изображения: ${src}`);
                    loadedCount++;
                };
            });
        }

        function setupEventListeners() {
            playBtn.addEventListener('click', startAppleCatchingGame);
            eventsBtn.addEventListener('click', openEventsSection);
            
            characterLobbyIconElement.addEventListener('click', () => {
                clickCharacter(gameData.selectedCharacterId);
            });
            
            charactersBtn.addEventListener('click', () => {
                showSection('characters');
            });
            
            shopBtn.addEventListener('click', () => {
                showSection('shop');
            });
            
            trophyRoadBtn.addEventListener('click', () => {
                showSection('trophy-road');
            });
            
            playAppleCatchingBtn.addEventListener('click', startAppleCatchingGame);
            playSurvivalBtn.addEventListener('click', startSurvivalGame);
            playChampionChallengeBtn.addEventListener('click', startChampionChallenge);
            
            applePassIconElement.addEventListener('click', () => {
                showSection('apple-pass');
            });
            
            closeCharactersBtn.addEventListener('click', () => {
                showSection('main');
            });
            
            closeShopBtn.addEventListener('click', () => {
                showSection('main');
            });
            
            closeTrophyRoadBtn.addEventListener('click', () => {
                showSection('main');
            });
            
            closeEventsBtn.addEventListener('click', () => {
                showSection('main');
            });
            
            closeApplePassBtn.addEventListener('click', () => {
                showSection('main');
            });
            
            buyUpgradeBtn.addEventListener('click', buyUpgrade);
            buyCaseBtn.addEventListener('click', buyCase);
            buyNewYearCaseBtn.addEventListener('click', buyNewYearCase);
            buyRiftCaseBtn.addEventListener('click', buyRiftCase);
            buyAnomalyCaseBtn.addEventListener('click', buyAnomalyCase);
            buyExclusive20Btn.addEventListener('click', () => buyExclusiveCharacter(20));
            buyExclusive21Btn.addEventListener('click', () => buyExclusiveCharacter(21));
            buyExclusive27Btn.addEventListener('click', () => buyExclusiveCharacter(27));
            buyExclusive28Btn.addEventListener('click', () => buyExclusiveCharacter(28));
            
            // === PATCH: ИСПРАВЛЕННЫЕ ОБРАБОТЧИКИ КЛИКОВ ===
            caseRewardStep1.addEventListener('click', () => {
                nextCaseRewardStep();
            });
            
            caseRewardStep2.addEventListener('click', () => {
                nextCaseRewardStep();
            });
            
            closeCaseBtn.addEventListener('click', handleCloseCase);
            
            exitGameBtn.addEventListener('click', exitAppleCatchingGame);
            exitSurvivalBtn.addEventListener('click', exitSurvivalGame);
            
            mysteriousChestRewardStep1.addEventListener('click', () => {
                nextMysteriousChestRewardStep();
            });
            
            mysteriousChestRewardStep2.addEventListener('click', () => {
                nextMysteriousChestRewardStep();
            });
            
            closeChestBtn.addEventListener('click', closeMysteriousChest);
            
            characterRevealOverlayElement.addEventListener('click', () => {
                characterRevealOverlayElement.style.display = 'none';
                showSection('main');
            });
            
            usePromoBtn.addEventListener('click', usePromoCode);
            promoCodeInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    usePromoCode();
                }
            });
            
            characterTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabName = tab.getAttribute('data-tab');
                    
                    characterTabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    renderCharacters(tabName);
                });
            });
            
            window.addEventListener('resize', () => {
                if (survivalGameInstance && survivalGameInstance.gameActive) {
                }
            });
            
            // === PATCH: ИСПРАВЛЕННЫЙ ОБРАБОТЧИК КЛИКА НА КЕЙС ===
            appleCaseElement.addEventListener('click', function() {
                const currentTitle = caseOpeningTitleElement.textContent;
                
                if (currentTitle.includes('Аномалия')) {
                    openCase('anomaly');
                } else if (currentTitle.includes('Разлом')) {
                    openCase('rift');
                } else if (currentTitle.includes('Новогодний')) {
                    openCase('newyear');
                } else {
                    openCase('standard');
                }
            });
            
            // === PATCH: ИСПРАВЛЕННЫЙ ОБРАБОТЧИК КЛИКА НА ТАИНСТВЕННЫЙ ЯЩИК ===
            mysteriousChestElement.addEventListener('click', function() {
                if (gameData.mysteriousChestAnimationInProgress) return;
                tapMysteriousChest();
            });

            // Обработчики для кнопок событий
            if (playRealityRiftBtn) {
                playRealityRiftBtn.addEventListener('click', startRealityRiftGame);
            }

            window.addEventListener('resize', initFloatingFragments);

            // Полноэкранный режим
            const fullscreenBtn = document.getElementById('fullscreen-btn');
            if (fullscreenBtn) {
                fullscreenBtn.addEventListener('click', function() {
                    if (!document.fullscreenElement) {
                        document.documentElement.requestFullscreen().catch(err => {
                            console.log(`Ошибка при включении полноэкранного режима: ${err.message}`);
                        });
                        fullscreenBtn.textContent = 'Выйти из полноэкранного режима';
                    } else {
                        document.exitFullscreen();
                        fullscreenBtn.textContent = 'Полный экран';
                    }
                });
            }
        }

        function openEventsSection() {
            checkTicketReset();
            updateSurvivalTicketsInfo();
            updateRealityRiftTicketsInfo();
            
            showSection('events');
        }

        function checkTicketReset() {
            const now = new Date();
            const mskTime = new Date(now.toLocaleString("en-US", {timeZone: "Europe/Moscow"}));
            
            const resetHour = 11;
            const lastReset = gameData.lastTicketReset ? new Date(gameData.lastTicketReset) : null;
            
            if (!lastReset || 
                (mskTime.getHours() >= resetHour && 
                 (lastReset.getDate() !== mskTime.getDate() || 
                  lastReset.getMonth() !== mskTime.getMonth() || 
                  lastReset.getFullYear() !== mskTime.getFullYear()))) {
                
                gameData.tickets = 15;
                gameData.lastTicketReset = Date.now();
                updateUI();
                updateSurvivalTicketsInfo();
                updateRealityRiftTicketsInfo();
                
                if (lastReset) {
                    showNotification("Билеты пополнены!", "Вам начислено 15 билетов на события", "tickets");
                }
            }
            
            saveGameData();
        }

        function updateSurvivalTicketsInfo() {
            if (survivalTicketsInfoElement) {
                survivalTicketsInfoElement.textContent = `Требуется: 1 билет (осталось: ${gameData.tickets})`;
            }
            
            if (playSurvivalBtn) {
                playSurvivalBtn.disabled = gameData.tickets <= 0;
            }
        }

        function startSurvivalGame() {
            if (gameData.tickets <= 0) {
                showNotification("Нет билетов", "Билеты пополняются каждый день в 11:00 по МСК", "tickets");
                return;
            }
            
            gameData.tickets--;
            updateUI();
            updateSurvivalTicketsInfo();
            updateRealityRiftTicketsInfo();
            
            eventsSectionElement.classList.remove('active');
            survivalGameElement.classList.add('active');
            
            if (survivalGameInstance) {
                survivalGameInstance.cleanup();
            }
            
            survivalGameInstance = new SurvivalGame();
            survivalGameInstance.init();
            
            saveGameData();
        }

        function exitSurvivalGame() {
            if (survivalGameInstance) {
                survivalGameInstance.cleanup();
                survivalGameInstance = null;
            }
            
            if (realityRiftGameInstance) {
                realityRiftGameInstance.cleanup();
                realityRiftGameInstance = null;
            }
            
            survivalGameElement.classList.remove('active');
            showSection('events');
        }

        function updateUI() {
            balanceElement.textContent = gameData.balance;
            upgradeLevelElement.textContent = gameData.upgradeLevel;
            trophiesCountElement.textContent = gameData.trophies;
            crystalsCountElement.textContent = gameData.crystals;
            ticketsCountElement.textContent = gameData.tickets;
            applePassPointsElement.textContent = gameData.applePassPoints;
            fractureEnergyCountElement.textContent = gameData.fractureEnergy;
            
            upgradePriceElement.textContent = 500;
            
            if (gameData.upgradeLevel >= gameData.maxUpgradeLevel) {
                buyUpgradeBtn.disabled = true;
                maxUpgradeElement.style.display = 'block';
            } else {
                buyUpgradeBtn.disabled = gameData.balance < 500;
                maxUpgradeElement.style.display = 'none';
            }
            
            buyCaseBtn.disabled = gameData.balance < 1000;
            
            if (buyNewYearCaseBtn) {
                buyNewYearCaseBtn.disabled = gameData.crystals < 1000 || !gameData.newYearCaseAvailable;
            }
            
            if (buyRiftCaseBtn) {
                buyRiftCaseBtn.disabled = gameData.fractureEnergy < 50;
            }
            
            if (buyAnomalyCaseBtn) {
                buyAnomalyCaseBtn.disabled = gameData.crystals < 500;
            }

            if (buyExclusive20Btn) {
                buyExclusive20Btn.disabled = gameData.crystals < 100000 || gameData.unlockedCharacters.includes(20);
            }
            if (buyExclusive21Btn) {
                buyExclusive21Btn.disabled = gameData.crystals < 100000 || gameData.unlockedCharacters.includes(21);
            }
            if (buyExclusive27Btn) {
                buyExclusive27Btn.disabled = gameData.crystals < 100000 || gameData.unlockedCharacters.includes(27);
            }
            if (buyExclusive28Btn) {
                buyExclusive28Btn.disabled = gameData.crystals < 100000 || gameData.unlockedCharacters.includes(28);
            }
            
            updateCharacterLobbyIcon();
            updateNotificationBadges();
            
            saveGameData();
        }

        function updateNotificationBadges() {
            const applePassUnclaimed = applePass22Rewards.filter(reward => 
                gameData.season22Data.applePass22Points >= reward.points && 
                !gameData.season22Data.applePass22Claimed.includes(reward.points)
            ).length;
            
            const trophyRoadUnclaimed = trophyRoadRewards.filter(reward => 
                gameData.trophies >= reward.trophies && 
                !gameData.claimedRewards.includes(reward.trophies)
            ).length;
            
            const applePassBadge = applePassIconElement.querySelector('.notification-badge');
            if (applePassBadge) {
                applePassBadge.remove();
            }
            
            if (applePassUnclaimed > 0) {
                const badge = document.createElement('div');
                badge.className = 'notification-badge';
                badge.textContent = applePassUnclaimed;
                applePassIconElement.appendChild(badge);
                applePassIconElement.classList.add('pulse-btn');
            } else {
                applePassIconElement.classList.remove('pulse-btn');
            }
            
            const trophyRoadBadge = trophyRoadBtn.querySelector('.notification-badge');
            if (trophyRoadBadge) {
                trophyRoadBadge.remove();
            }
            
            if (trophyRoadUnclaimed > 0) {
                const badge = document.createElement('div');
                badge.className = 'notification-badge';
                badge.textContent = trophyRoadUnclaimed;
                trophyRoadBtn.appendChild(badge);
                trophyRoadBtn.classList.add('pulse-btn');
            } else {
                trophyRoadBtn.classList.remove('pulse-btn');
            }
            
            const eventsBadge = eventsBtn.querySelector('.notification-badge');
            if (eventsBadge) {
                eventsBadge.remove();
            }
            
            if (gameData.tickets > 0) {
                eventsBtn.classList.add('pulse-btn');
            } else {
                eventsBtn.classList.remove('pulse-btn');
            }
        }

        function updateCharacterLobbyIcon() {
            const character = gameData.characters.find(c => c.id === gameData.selectedCharacterId);
            if (!character) return;
            
            const isUnlocked = gameData.unlockedCharacters.includes(character.id);
            const trophies = gameData.characterTrophies[gameData.selectedCharacterId] || 0;
            const league = calculateLeague(trophies);
            
            let html = character.icon;
            
            if (isUnlocked) {
                html += `<div style="position: absolute; bottom: 0; right: 0; background: ${league.color}; color: white; border-radius: 50%; width: 50px; height: 50px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 10px; border: 2px solid white; box-shadow: 0 0 10px rgba(${league.color === '#FFD700' ? '255, 215, 0' : '138, 43, 226'}, 0.7);">
                    <div style="font-size: 14px;">${league.icon}</div>
                    <div style="font-size: 9px; margin-top: 2px;">${league.rankInLeague}/${league.name.length}</div>
                </div>
                <div style="position: absolute; top: 0; right: 0; background: rgba(0, 0, 0, 0.7); color: #FFD700; padding: 5px 10px; border-radius: 10px; font-size: 12px; font-weight: bold; border: 1px solid #FFD700;">
                    🏆 ${trophies}
                </div>`;
            }
            
            characterLobbyIconElement.innerHTML = html;
            
            if (!isUnlocked) {
                characterLobbyIconElement.style.opacity = "0.5";
            } else {
                characterLobbyIconElement.style.opacity = "1";
            }
        }

        function renderCharacters(activeTab = 'all') {
            characterListElement.innerHTML = '';
            
            let filteredCharacters = [];
            
            if (activeTab === 'all') {
                filteredCharacters = gameData.characters.filter(char => 
                    char.rarity !== 'trophy' && char.rarity !== 'exclusive'
                );
            } else if (activeTab === 'trophy') {
                filteredCharacters = gameData.characters.filter(char => 
                    char.rarity === 'trophy'
                );
            } else if (activeTab === 'exclusive') {
                filteredCharacters = gameData.characters.filter(char => 
                    char.rarity === 'exclusive'
                );
            }
            
            const unlockedCharacters = filteredCharacters.filter(character => 
                gameData.unlockedCharacters.includes(character.id) ||
                gameData.season22Data.anomalyCharactersUnlocked.includes(character.id) ||
                gameData.season22Data.fractureCharactersUnlocked.includes(character.id)
            );
            
            const lockedCharacters = filteredCharacters.filter(character => 
                !gameData.unlockedCharacters.includes(character.id) &&
                !gameData.season22Data.anomalyCharactersUnlocked.includes(character.id) &&
                !gameData.season22Data.fractureCharactersUnlocked.includes(character.id)
            );
            
            if (unlockedCharacters.length > 0) {
                const unlockedCategory = document.createElement('div');
                unlockedCategory.className = 'character-category';
                unlockedCategory.textContent = 'Разблокированные';
                characterListElement.appendChild(unlockedCategory);
                
                unlockedCharacters.forEach(character => {
                    const isSelected = gameData.selectedCharacterId === character.id;
                    const trophies = gameData.characterTrophies[character.id] || 0;
                    const league = calculateLeague(trophies);
                    
                    const characterElement = document.createElement('div');
                    characterElement.className = `character-item unlocked ${isSelected ? 'selected' : ''}`;
                    characterElement.addEventListener('click', () => selectCharacter(character.id));
                    
                    const isSeasonal = character.id >= 22;
                    const seasonalBadge = isSeasonal ? '<div style="color: #8A2BE2; font-size: 12px; margin-top: 5px;">СЕЗОН 22</div>' : '';
                    
                    characterElement.innerHTML = `
                        <div class="character-icon ${character.borderClass}">
                            ${character.icon}
                        </div>
                        <div class="character-name ${character.colorClass}">${character.name}</div>
                        <div class="character-rarity ${character.colorClass}">${rarityNames[character.rarity]}</div>
                        <div style="color: ${league.color}; font-size: 12px; margin-top: 5px; font-weight: bold;">
                            ${league.icon} ${league.name} ${league.rankInLeague}
                        </div>
                        <div style="color: #FFD700; font-size: 12px; margin-top: 3px;">🏆 ${trophies} кубков</div>
                        ${isSelected ? '<div style="color: #ff6b00; margin-top: 10px; font-weight: bold;">✓ ВЫБРАН</div>' : ''}
                        ${seasonalBadge}
                    `;
                    
                    characterListElement.appendChild(characterElement);
                });
            }
            
            if (lockedCharacters.length > 0) {
                const lockedCategory = document.createElement('div');
                lockedCategory.className = 'character-category';
                lockedCategory.textContent = 'Заблокированные';
                characterListElement.appendChild(lockedCategory);
                
                lockedCharacters.forEach(character => {
                    const characterElement = document.createElement('div');
                    characterElement.className = `character-item locked`;
                    
                    let lockedText = 'ОТКРЫВАЙ КЕЙСЫ, ЧТОБЫ РАЗБЛОКИРОВАТЬ!';
                    if (character.rarity === 'trophy') {
                        lockedText = 'ПОВЫШАЙ КУБКИ И ОТКРЫВАЙ ТАИНСТВЕННЫЕ ЯЩИКИ, ЧТОБЫ РАЗБЛОКИРОВАТЬ';
                    } else if (character.rarity === 'exclusive') {
                        if (character.id >= 27) {
                            lockedText = 'ТОЛЬКО ИЗ КЕЙСА "АНОМАЛИЯ" (СЕЗОН 22)';
                        } else {
                            lockedText = 'ЭКСКЛЮЗИВНЫЙ ПЕРСОНАЖ';
                        }
                    } else if (character.id >= 22 && character.id <= 26) {
                        lockedText = 'ОТКРЫВАЙ КЕЙСЫ "РАЗЛОМ" ИЗ APPLE PASS 22';
                    }
                    
                    const seasonalBadge = character.id >= 22 ? '<div style="color: #8A2BE2; font-size: 12px; margin-top: 5px;">СЕЗОН 22</div>' : '';
                    
                    characterElement.innerHTML = `
                        <div class="character-icon ${character.borderClass}">
                            ${character.icon}
                        </div>
                        <div class="character-name ${character.colorClass}">${character.name}</div>
                        <div class="character-rarity ${character.colorClass}">${rarityNames[character.rarity]}</div>
                        <div class="locked-text">${lockedText}</div>
                        ${seasonalBadge}
                    `;
                    
                    characterListElement.appendChild(characterElement);
                });
            }
        }

        function selectCharacter(characterId) {
            const isUnlocked = gameData.unlockedCharacters.includes(characterId) ||
                              gameData.season22Data.anomalyCharactersUnlocked.includes(characterId) ||
                              gameData.season22Data.fractureCharactersUnlocked.includes(characterId);
            
            if (!isUnlocked) {
                showNotification('Персонаж заблокирован', 'Открывайте кейсы, чтобы разблокировать новых персонажей', 'money');
                return;
            }
            
            gameData.selectedCharacterId = characterId;
            renderCharacters(document.querySelector('.character-tab.active').getAttribute('data-tab'));
            updateCharacterLobbyIcon();
            
            const character = gameData.characters.find(c => c.id === characterId);
            showNotification('Персонаж выбран', `Теперь вы используете: ${character.name}`, 'unlock');
            
            saveGameData();
        }

        function clickCharacter(characterId) {
            const isUnlocked = gameData.unlockedCharacters.includes(characterId) ||
                              gameData.season22Data.anomalyCharactersUnlocked.includes(characterId) ||
                              gameData.season22Data.fractureCharactersUnlocked.includes(characterId);
            
            if (!isUnlocked) {
                showNotification('Персонаж заблокирован', 'Открывайте кейсы, чтобы разблокировать новых персонажей', 'money');
                return;
            }
            
            gameData.balance += gameData.upgradeLevel;
            gameData.applePassPoints += 1;
            gameData.season22Data.applePass22Points += 1;
            renderApplePass22Rewards();
            
            updateUI();
        }

        function buyUpgrade() {
            if (gameData.balance >= 500 && gameData.upgradeLevel < gameData.maxUpgradeLevel) {
                gameData.balance -= 500;
                gameData.upgradeLevel += 1;
                
                showNotification('Улучшение куплено!', `Теперь ваш доход за клик: ${gameData.upgradeLevel}`, 'unlock');
                
                updateUI();
            }
        }

        function buyCase() {
            if (gameData.balance >= 1000) {
                gameData.balance -= 1000;
                gameData.caseItems = Math.random() > 0.5 ? 1 : 2;
                
                shopSectionElement.classList.remove('active');
                caseOpeningElement.style.display = 'flex';
                playBtn.style.display = 'none';
                eventsBtn.style.display = 'none';
                
                resetCaseState();
                appleCaseElement.style.display = 'flex';
                caseCountElement.textContent = `Предметов: ${gameData.caseItems}`;
                closeCaseBtn.style.display = 'none';
                
                setTimeout(() => {
                    caseHintElement.style.opacity = '1';
                    caseHintElement.style.transition = 'opacity 0.5s';
                    appleCaseElement.classList.add('case-shake');
                }, 1000);
                
                updateUI();
            }
        }

        function buyNewYearCase() {
            if (gameData.crystals >= 1000 && gameData.newYearCaseAvailable) {
                gameData.crystals -= 1000;
                gameData.caseItems = Math.random() > 0.5 ? 1 : 2;
                
                shopSectionElement.classList.remove('active');
                caseOpeningElement.style.display = 'flex';
                playBtn.style.display = 'none';
                eventsBtn.style.display = 'none';
                
                resetCaseState();
                appleCaseElement.style.display = 'flex';
                caseCountElement.textContent = `Предметов: ${gameData.caseItems}`;
                closeCaseBtn.style.display = 'none';
                
                setTimeout(() => {
                    caseHintElement.style.opacity = '1';
                    caseHintElement.style.transition = 'opacity 0.5s';
                    appleCaseElement.classList.add('case-shake');
                }, 1000);
                
                updateUI();
                
                caseOpeningTitleElement.textContent = 'Откройте Новогодний Кейс!';
                appleCaseElement.style.backgroundImage = 'url(\'https://i.ibb.co/2cVjYhR/new-year-case.png\')';
            }
        }

        function checkChampionEnergyReset() {
            const now = new Date();
            const lastReset = gameData.lastChampionEnergyReset ? new Date(gameData.lastChampionEnergyReset) : new Date(0);
            const hoursPassed = (now - lastReset) / (1000 * 60 * 60);
            
            if (hoursPassed >= 1) {
                gameData.championEnergy = Math.min(3, gameData.championEnergy + Math.floor(hoursPassed));
                gameData.lastChampionEnergyReset = now.toISOString();
                if (gameData.championEnergy > 3) gameData.championEnergy = 3;
                saveGameData();
            }
        }

        function startChampionChallenge() {
            if (gameData.selectedCharacterId === null) {
                showNotification('⚠️ НЕ ВЫБРАН ПЕРСОНАЖ', 'Выберите персонажа в разделе Персонажи', 'warning');
                return;
            }

            gameData.gameTime = 10;
            gameData.gameScore = 0;
            gameData.apples = [];
            
            mainMenuElement.style.display = 'none';
            eventsSectionElement.classList.remove('active');
            appleCatchingGameElement.style.display = 'flex';
            playBtn.style.display = 'none';
            eventsBtn.style.display = 'none';
            
            gameTargetElement.textContent = 'Цель: поймайте яблоки для кубков!';
            gameScoreElement.textContent = `Кубков: 0`;
            gameTimerElement.textContent = `⏱️ 10`;
            
            const selectedChar = gameData.characters.find(c => c.id === gameData.selectedCharacterId);
            const challengeTitle = document.querySelector('.game-header h1') || document.createElement('h1');
            challengeTitle.textContent = `🏆 Ранговое испытание: ${selectedChar.name}`;
            
            gameActive = true;
            gameTimer = setInterval(() => {
                gameData.gameTime--;
                gameTimerElement.textContent = `⏱️ ${gameData.gameTime}`;
                
                if (gameData.gameTime <= 0) {
                    endChampionGameSession();
                }
            }, 1000);
            
            spawnApples();
        }

        function spawnApples() {
            if (!gameActive) return;
            
            const gameArea = document.querySelector('.game-area') || appleCatchingGameElement;
            for (let i = 0; i < 3; i++) {
                const apple = document.createElement('div');
                apple.className = 'apple';
                apple.innerHTML = '🍎';
                apple.style.left = Math.random() * 90 + '%';
                apple.style.top = Math.random() * 70 + '%';
                apple.style.cursor = 'pointer';
                
                apple.addEventListener('click', () => {
                    gameData.gameScore += 10;
                    gameScoreElement.textContent = `Кубков: ${gameData.gameScore}`;
                    apple.remove();
                });
                
                gameArea.appendChild(apple);
            }
            
            if (gameActive) {
                setTimeout(spawnApples, 800);
            }
        }

        function endChampionGameSession() {
            gameActive = false;
            clearInterval(gameTimer);
            
            const charId = gameData.selectedCharacterId;
            if (!gameData.characterTrophies[charId]) {
                gameData.characterTrophies[charId] = 0;
            }
            
            gameData.characterTrophies[charId] += gameData.gameScore;
            gameData.trophies += gameData.gameScore;
            gameData.applePassPoints += gameData.gameScore;
            gameData.season22Data.applePass22Points += gameData.gameScore;
            
            const selectedChar = gameData.characters.find(c => c.id === charId);
            
            setTimeout(() => {
                appleCatchingGameElement.style.display = 'none';
                mainMenuElement.style.display = 'flex';
                playBtn.style.display = 'block';
                eventsBtn.style.display = 'block';
                
                showNotification('🏆 РАНГОВОЕ ИСПЫТАНИЕ ЗАВЕРШЕНО!', 
                    `${selectedChar.name} получил +${gameData.gameScore} кубков!`, 
                    'money');
                
                renderApplePass22Rewards();
                updateUI();
                saveGameData();
            }, 500);
        }

        function startAppleCatchingGame() {
            mainMenuElement.style.display = 'none';
            charactersSectionElement.classList.remove('active');
            shopSectionElement.classList.remove('active');
            trophyRoadSectionElement.classList.remove('active');
            eventsSectionElement.classList.remove('active');
            applePassSectionElement.classList.remove('active');
            
            appleCatchingGameElement.classList.add('active');
            gameEndScreenElement.style.display = 'none';
            playBtn.style.display = 'none';
            eventsBtn.style.display = 'none';
            
            gameData.gameActive = true;
            gameData.gameTime = 30;
            gameData.gameScore = 0;
            gameData.apples = [];
            
            gameTimerElement.textContent = gameData.gameTime;
            gameScoreElement.textContent = gameData.gameScore;
            gameTargetElement.textContent = "Поймайте 20 яблок за 30 секунд!";
            
            const apples = document.querySelectorAll('.apple');
            apples.forEach(apple => apple.remove());
            
            gameData.gameTimer = setInterval(updateGameTimer, 1000);
            
            createApple();
        }

        function createApple() {
            if (!gameData.gameActive) return;
            
            const apple = document.createElement('div');
            apple.className = 'apple';
            apple.innerHTML = '🍎';
            apple.style.position = 'absolute';
            
            const maxX = window.innerWidth - 100;
            const maxY = window.innerHeight - 150;
            const x = Math.floor(Math.random() * maxX);
            const y = Math.floor(Math.random() * maxY);
            
            apple.style.left = `${x}px`;
            apple.style.top = `${y}px`;
            
            apple.addEventListener('click', () => catchApple(apple));
            
            appleCatchingGameElement.appendChild(apple);
            gameData.apples.push(apple);
            
            const nextAppleTime = 500 + Math.random() * 1500;
            setTimeout(createApple, nextAppleTime);
        }

        function catchApple(appleElement) {
            if (!gameData.gameActive) return;
            
            gameData.gameScore++;
            gameScoreElement.textContent = gameData.gameScore;
            
            appleElement.classList.add('caught');
            
            const index = gameData.apples.indexOf(appleElement);
            if (index > -1) {
                gameData.apples.splice(index, 1);
            }
            
            setTimeout(() => {
                if (appleElement.parentNode) {
                    appleElement.parentNode.removeChild(appleElement);
                }
            }, 500);
            
            if (gameData.gameScore >= 20) {
                endAppleCatchingGame(true);
            }
        }

        function updateGameTimer() {
            if (!gameData.gameActive) return;
            
            gameData.gameTime--;
            gameTimerElement.textContent = gameData.gameTime;
            
            gameTargetElement.textContent = `Поймайте ${20 - gameData.gameScore} яблок за ${gameData.gameTime} секунд!`;
            
            if (gameData.gameTime <= 0) {
                endAppleCatchingGame(false);
            }
        }

        function endAppleCatchingGame(win) {
            gameData.gameActive = false;
            clearInterval(gameData.gameTimer);
            
            gameData.apples.forEach(apple => {
                if (apple.parentNode) {
                    apple.parentNode.removeChild(apple);
                }
            });
            gameData.apples = [];
            
            gameEndScreenElement.style.display = 'flex';
            
            if (win) {
                gameResultElement.textContent = "ПОБЕДА!";
                gameResultElement.className = "game-result game-won";
                gameStatsElement.textContent = `Вы поймали ${gameData.gameScore} яблок за ${30 - gameData.gameTime} секунд!`;
                
                let trophyReward;
                if (gameData.trophies >= 10000) {
                    trophyReward = 100;
                } else if (gameData.trophies >= 1000) {
                    trophyReward = 50;
                } else {
                    trophyReward = 10;
                }
                
                gameData.trophies += trophyReward;
                
                if (!gameData.characterTrophies[gameData.selectedCharacterId]) {
                    gameData.characterTrophies[gameData.selectedCharacterId] = 0;
                }
                gameData.characterTrophies[gameData.selectedCharacterId] += trophyReward;
                
                showNotification(`+${trophyReward} кубков`, `Вы выиграли в "Ловле яблок" и получили ${trophyReward} кубков!`, 'trophies');
            } else {
                gameResultElement.textContent = "ПОРАЖЕНИЕ";
                gameResultElement.className = "game-result game-lost";
                gameStatsElement.textContent = `Вы поймали только ${gameData.gameScore} яблок из 20`;
                
                if (gameData.trophies >= 10) {
                    gameData.trophies -= 10;
                    if (!gameData.characterTrophies[gameData.selectedCharacterId]) {
                        gameData.characterTrophies[gameData.selectedCharacterId] = 0;
                    }
                    if (gameData.characterTrophies[gameData.selectedCharacterId] >= 10) {
                        gameData.characterTrophies[gameData.selectedCharacterId] -= 10;
                    }
                    showNotification(`-10 кубков`, `Вы проиграли в "Ловле яблок" и потеряли 10 кубков`, 'trophies');
                } else {
                    showNotification(`Кубки не изменились`, `У вас меньше 10 кубков, поэтому вы ничего не потеряли`, 'trophies');
                }
            }
            
            updateUI();
            updateTrophyRoad();
        }

        function exitAppleCatchingGame() {
            appleCatchingGameElement.classList.remove('active');
            showSection('main');
        }

        function updateTrophyRoad() {
            const maxTrophies = 40000;
            const fillPercentage = Math.min((gameData.trophies / maxTrophies) * 100, 100);
            trophyRoadFillElement.style.width = `${fillPercentage}%`;
            
            currentTrophiesElement.textContent = `${gameData.trophies} кубков`;
            
            const nextReward = trophyRoadRewards.find(reward => 
                reward.trophies > gameData.trophies && !gameData.claimedRewards.includes(reward.trophies)
            );
            
            if (nextReward) {
                nextMilestoneElement.textContent = `${nextReward.trophies} кубков`;
            } else {
                nextMilestoneElement.textContent = "Максимум";
            }
            
            renderTrophyRoadRewards();
            updateNotificationBadges();
        }

        function renderTrophyRoadRewards() {
            trophyRoadRewardsElement.innerHTML = '';
            
            trophyRoadRewards.forEach(rewardData => {
                const isClaimed = gameData.claimedRewards.includes(rewardData.trophies);
                const isAvailable = gameData.trophies >= rewardData.trophies && !isClaimed;
                
                const rewardItem = document.createElement('div');
                rewardItem.className = `trophy-reward-item ${isClaimed ? 'claimed' : isAvailable ? 'available' : 'locked'}`;
                
                // === PATCH: ИСПРАВЛЕН ОБРАБОТЧИК ДЛЯ ТАИНСТВЕННЫХ ЯЩИКОВ ===
                if (isAvailable) {
                    if (rewardData.reward.type === 'mysterious_chest') {
                        rewardItem.addEventListener('click', () => claimAndOpenTrophyChest(rewardData));
                    } else {
                        rewardItem.addEventListener('click', () => claimTrophyReward(rewardData));
                    }
                }
                
                let iconClass = '';
                let iconContent = '';
                let rewardName = '';
                let rewardAmount = '';
                
                if (rewardData.reward.type === 'mysterious_chest') {
                    iconClass = 'mysterious-chest-icon';
                    iconContent = '';
                    rewardName = 'Таинственный ящик';
                    rewardAmount = `x${rewardData.reward.amount}`;
                } else if (rewardData.reward.type === 'money') {
                    iconClass = 'money-icon-trophy';
                    iconContent = '';
                    rewardName = 'F-BUCKS';
                    rewardAmount = `${rewardData.reward.amount}`;
                } else if (rewardData.reward.type === 'crystals') {
                    iconClass = 'crystal-icon-trophy';
                    iconContent = '💎';
                    rewardName = 'Кристаллы';
                    rewardAmount = `${rewardData.reward.amount}`;
                } else if (rewardData.reward.type === 'fracture_energy') {
                    iconClass = 'fas fa-bolt';
                    iconContent = '';
                    rewardName = 'Энергия разлома';
                    rewardAmount = `${rewardData.reward.amount}`;
                } else if (rewardData.reward.type === 'rift_case') {
                    iconClass = 'shop-item-icon rift-case-icon';
                    iconContent = '';
                    rewardName = 'Кейс "Разлом"';
                    rewardAmount = `x${rewardData.reward.amount}`;
                } else if (rewardData.reward.type === 'anomaly_case') {
                    iconClass = 'shop-item-icon anomaly-case-icon';
                    iconContent = '';
                    rewardName = 'Кейс "Аномалия"';
                    rewardAmount = `x${rewardData.reward.amount}`;
                }
                
                rewardItem.innerHTML = `
                    <div class="reward-trophies">${rewardData.trophies}</div>
                    ${rewardData.reward.milestone ? '<div class="reward-new-milestone">НОВЫЙ РУБЕЖ!</div>' : ''}
                    <div class="reward-icon-trophy ${iconClass}">${iconContent}</div>
                    <div class="reward-name">${rewardName}</div>
                    <div class="reward-amount">${rewardAmount}</div>
                    ${isClaimed ? '<div style="color: #4CAF50; margin-top: 10px; font-weight: bold;">✓ ПОЛУЧЕНО</div>' : ''}
                `;
                
                trophyRoadRewardsElement.appendChild(rewardItem);
            });
        }

        // === PATCH: НОВАЯ ФУНКЦИЯ ДЛЯ ОТКРЫТИЯ ТАИНСТВЕННОГО ЯЩИКА ИЗ ТРОФЕЙНОЙ ДОРОГИ ===
        function claimAndOpenTrophyChest(rewardData) {
            gameData.claimedRewards.push(rewardData.trophies);
            openMysteriousChestFromReward(rewardData.reward.amount);
            updateUI();
            updateTrophyRoad();
            saveGameData();
        }

        function claimTrophyReward(rewardData) {
            gameData.claimedRewards.push(rewardData.trophies);
            
            if (rewardData.reward.type === 'money') {
                gameData.balance += rewardData.reward.amount;
                showNotification(`+${rewardData.reward.amount} F-BUCKS`, `Вы получили награду за ${rewardData.trophies} кубков!`, 'money');
            }
            else if (rewardData.reward.type === 'crystals') {
                gameData.crystals += rewardData.reward.amount;
                showNotification(`+${rewardData.reward.amount} кристаллов`, `Вы получили награду за ${rewardData.trophies} кубков!`, 'crystals');
            }
            else if (rewardData.reward.type === 'fracture_energy') {
                gameData.fractureEnergy += rewardData.reward.amount;
                showNotification(`+${rewardData.reward.amount} энергии разлома`, `Вы получили награду за ${rewardData.trophies} кубков!`, 'fracture');
            }
            else if (rewardData.reward.type === 'rift_case') {
                gameData.season22Data.riftCasesOpened += rewardData.reward.amount;
                showNotification(`+${rewardData.reward.amount} кейс(ов) "Разлом"`, `Вы получили награду за ${rewardData.trophies} кубков!`, 'fracture');
            }
            else if (rewardData.reward.type === 'anomaly_case') {
                gameData.season22Data.anomalyCasesOpened += rewardData.reward.amount;
                showNotification(`+${rewardData.reward.amount} кейс(ов) "Аномалия"`, `Вы получили награду за ${rewardData.trophies} кубков!`, 'fracture');
            }
            
            updateUI();
            updateTrophyRoad();
            saveGameData();
        }

        function openMysteriousChest() {
            resetMysteriousChestState();
            
            mysteriousChestOpeningElement.style.display = 'flex';
            closeChestBtn.style.display = 'none';
            mysteriousChestRewardStep1.style.display = 'none';
            mysteriousChestRewardStep2.style.display = 'none';
            playBtn.style.display = 'none';
            eventsBtn.style.display = 'none';
            
            [chestCrack1, chestCrack2, chestCrack3, chestCrack4, chestCrack5].forEach(crack => {
                crack.style.opacity = '0';
                createRandomCracks(crack);
            });
            
            chestTapCounterElement.textContent = `Нажмите на ящик: 0/5`;
            
            mysteriousChestElement.classList.remove('chest-open-animation');
            mysteriousChestElement.style.display = 'flex';
        }

        function createRandomCracks(crackElement) {
            const width = 300;
            const height = 250;
            let svg = `<svg xmlns="http://www.w3.org/2000/svg" width="${width}" height="${height}">`;
            
            const crackCount = Math.floor(Math.random() * 5) + 3;
            
            for (let i = 0; i < crackCount; i++) {
                const startX = Math.random() * width;
                const startY = Math.random() * height;
                
                let path = `M ${startX} ${startY} `;
                
                const segments = Math.floor(Math.random() * 5) + 3;
                
                for (let j = 0; j < segments; j++) {
                    const endX = startX + (Math.random() * 60 - 30);
                    const endY = startY + (Math.random() * 60 - 30);
                    path += `L ${Math.max(0, Math.min(width, endX))} ${Math.max(0, Math.min(height, endY))} `;
                }
                
                svg += `<path d="${path}" stroke="black" stroke-width="3" fill="none" stroke-linecap="round"/>`;
            }
            
            svg += `</svg>`;
            crackElement.style.backgroundImage = `url('data:image/svg+xml;utf8,${encodeURIComponent(svg)}')`;
        }

        function showNextMysteriousChestReward() {
            if (gameData.currentMysteriousChestStep >= gameData.currentMysteriousChestRewards.length) {
                closeChestBtn.style.display = 'block';
                gameData.mysteriousChestAnimationInProgress = false;
                return;
            }
            
            const reward = gameData.currentMysteriousChestRewards[gameData.currentMysteriousChestStep];
            
            if (reward.type === 'money') {
                mysteriousChestMoneyRewardElement.textContent = `F-BUCKS: +${reward.value}`;
                mysteriousChestRewardStep1.style.display = 'flex';
                mysteriousChestRewardStep1.classList.add('active');
                mysteriousChestRewardStep2.style.display = 'none';
                mysteriousChestRewardStep2.classList.remove('active');
                
                gameData.balance += reward.value;
                updateUI();
                
            } else if (reward.type === 'character') {
                const isNew = !gameData.unlockedCharacters.includes(reward.character.id);
                
                if (isNew) {
                    mysteriousChestCharacterIconElement.innerHTML = reward.character.icon;
                    mysteriousChestCharacterTextElement.textContent = `НОВЫЙ ТРОФЕЙНЫЙ ПЕРСОНАЖ: ${reward.character.name}`;
                    
                    gameData.unlockedCharacters.push(reward.character.id);
                    renderCharacters();
                    updateCharacterLobbyIcon();
                    
                    mysteriousChestRewardStep1.style.display = 'none';
                    mysteriousChestRewardStep1.classList.remove('active');
                    mysteriousChestRewardStep2.style.display = 'flex';
                    mysteriousChestRewardStep2.classList.add('active');
                } else {
                    gameData.currentMysteriousChestStep++;
                    showNextMysteriousChestReward();
                    return;
                }
            }
            
            const remaining = gameData.currentMysteriousChestRewards.length - gameData.currentMysteriousChestStep - 1;
            mysteriousChestRemainingItemsElement.textContent = `Осталось предметов: ${remaining}`;
        }

        function nextMysteriousChestRewardStep() {
            gameData.currentMysteriousChestStep++;
            showNextMysteriousChestReward();
        }

        function closeMysteriousChest() {
            resetMysteriousChestState();
            mysteriousChestOpeningElement.style.display = 'none';
            gameData.chestsToOpen--;
            
            if (gameData.chestsToOpen > 0) {
                setTimeout(() => {
                    openMysteriousChest();
                }, 500);
            } else {
                if (openingCaseFromTrophyRoad) {
                    openingCaseFromTrophyRoad = false;
                    showSection('trophy-road');
                } else {
                    showSection('main');
                }
            }
        }

        function showCharacterReveal(character) {
            characterRevealOverlayElement.style.display = 'flex';
            
            characterRevealBackgroundElement.className = `character-reveal-background background-${character.rarity}`;
            
            revealedCharacterElement.innerHTML = character.icon;
            
            characterRevealNameElement.textContent = character.name;
            characterRevealRarityElement.textContent = rarityNames[character.rarity];
            characterRevealRarityElement.className = `character-reveal-rarity ${character.colorClass}`;
            
            showNotification('НОВЫЙ ПЕРСОНАЖ!', `Вы получили: ${character.name}`, 'unlock');
        }

        function usePromoCode() {
            const code = promoCodeInput.value.trim().toLowerCase();
            
            if (!code) {
                promoMessage.textContent = 'Введите промокод';
                promoMessage.style.color = '#ff6b6b';
                return;
            }
            
            if (gameData.usedPromoCodes.includes(code)) {
                promoMessage.textContent = 'Промокод уже использован';
                promoMessage.style.color = '#ff6b6b';
                return;
            }
            
            if (promoCodes[code]) {
                const reward = promoCodes[code];
                gameData.usedPromoCodes.push(code);
                
                if (reward.type === 'money') {
                    gameData.balance += reward.amount;
                    showNotification(`+${reward.amount} F-BUCKS`, `Промокод "${code}" активирован!`, 'money');
                    promoMessage.textContent = `Получено ${reward.amount} F-BUCKS!`;
                    promoMessage.style.color = '#ffcc00';
                } else if (reward.type === 'crystals') {
                    gameData.crystals += reward.amount;
                    showNotification(`+${reward.amount} кристаллов`, `Промокод "${code}" активирован!`, 'crystals');
                    promoMessage.textContent = `Получено ${reward.amount} кристаллов!`;
                    promoMessage.style.color = '#00ffff';
                } else if (reward.type === 'character') {
                    const character = charactersData.find(c => c.id === reward.characterId);
                    if (character) {
                        if (!gameData.unlockedCharacters.includes(character.id)) {
                            gameData.unlockedCharacters.push(character.id);
                            gameData.skullCharacterUnlocked = true;
                            
                            if (character.id === 21) {
                                showCharacterReveal(character);
                                promoMessage.textContent = 'Разблокирован персонаж Череп!';
                                promoMessage.style.color = '#ff00ff';
                            } else {
                                showNotification('НОВЫЙ ПЕРСОНАЖ!', `Вы получили: ${character.name}`, 'unlock');
                                promoMessage.textContent = `Разблокирован персонаж ${character.name}!`;
                                promoMessage.style.color = '#ff00ff';
                            }
                        } else {
                            promoMessage.textContent = 'Персонаж уже разблокирован';
                            promoMessage.style.color = '#ff6b6b';
                        }
                    }
                } else if (reward.type === 'fracture_energy') {
                    gameData.fractureEnergy += reward.amount;
                    showNotification(`+${reward.amount} энергии разлома`, `Промокод "${code}" активирован!`, 'fracture');
                    promoMessage.textContent = `Получено ${reward.amount} энергии разлома!`;
                    promoMessage.style.color = '#8A2BE2';
                } else if (reward.type === 'anomaly_case') {
                    gameData.season22Data.anomalyCasesOpened += reward.amount;
                    showNotification(`+${reward.amount} кейс(ов) "Аномалия"`, `Промокод "${code}" активирован!`, 'fracture');
                    promoMessage.textContent = `Получено ${reward.amount} кейс(ов) "Аномалия"!`;
                    promoMessage.style.color = '#8A2BE2';
                }
                
                updateUI();
                renderCharacters();
                saveGameData();
                promoCodeInput.value = '';
            } else {
                promoMessage.textContent = 'Неверный промокод';
                promoMessage.style.color = '#ff6b6b';
            }
        }

        function showNotification(title, message, type) {
            const notificationContainer = document.getElementById('notification-container');
            
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <div class="notification-title">${title}</div>
                <div class="notification-message">${message}</div>
            `;
            
            notificationContainer.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 10);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 500);
            }, 3000);
        }

        function calculateLeague(trophies) {
            const leagues = [
                { name: "Bronze", min: 0, max: 299, icon: "🥉", color: "#D2691E", rank: 1 },
                { name: "Silver", min: 300, max: 599, icon: "🥈", color: "#C0C0C0", rank: 2 },
                { name: "Gold", min: 600, max: 899, icon: "🥇", color: "#FFD700", rank: 3 },
                { name: "Diamond", min: 900, max: 1199, icon: "💎", color: "#00BFFF", rank: 4 },
                { name: "Mythic", min: 1200, max: 1499, icon: "⭐", color: "#9370DB", rank: 5 },
                { name: "Legend", min: 1500, max: Infinity, icon: "👑", color: "rainbow", rank: 6 }
            ];

            const league = leagues.find(l => trophies >= l.min && trophies <= l.max);
            if (!league) return leagues[0];
            
            const rankInLeague = Math.floor((trophies - league.min) / 10) + 1;
            return { ...league, rankInLeague, totalTrophies: trophies };
        }

        function saveGameData() {
            localStorage.setItem('appleRebirthGame', JSON.stringify(gameData));
        }

        function showSection(sectionName) {
            const fullscreenBtn = document.getElementById('fullscreen-btn');
            mainMenuElement.style.display = 'none';
            charactersSectionElement.classList.remove('active');
            shopSectionElement.classList.remove('active');
            trophyRoadSectionElement.classList.remove('active');
            eventsSectionElement.classList.remove('active');
            applePassSectionElement.classList.remove('active');
            if (fullscreenBtn) fullscreenBtn.style.display = 'none';
            
            playBtn.style.display = 'none';
            eventsBtn.style.display = 'none';
            
            switch(sectionName) {
                case 'main':
                    mainMenuElement.style.display = 'flex';
                    playBtn.style.display = 'block';
                    eventsBtn.style.display = 'block';
                    if (fullscreenBtn) fullscreenBtn.style.display = 'block';
                    break;
                case 'characters':
                    charactersSectionElement.classList.add('active');
                    break;
                case 'shop':
                    shopSectionElement.classList.add('active');
                    break;
                case 'trophy-road':
                    trophyRoadSectionElement.classList.add('active');
                    break;
                case 'events':
                    eventsSectionElement.classList.add('active');
                    break;
                case 'apple-pass':
                    applePassSectionElement.classList.add('active');
                    break;
            }
        }

        function getRandomCharacter() {
            const availableCharacters = gameData.characters.filter(char => 
                char.rarity !== "trophy" && 
                char.rarity !== "exclusive" && 
                !gameData.unlockedCharacters.includes(char.id) &&
                char.id < 22
            );
            
            if (availableCharacters.length === 0) {
                return null;
            }
            
            const rarityChances = {
                "common": 10,
                "rare": 40,
                "super-rare": 30,
                "epic": 15,
                "mythic": 3,
                "legendary": 1.5,
                "monochrome": 0.5
            };
            
            const random = Math.random() * 100;
            let selectedRarity = "common";
            let cumulativeChance = 0;
            
            for (const [rarity, chance] of Object.entries(rarityChances)) {
                cumulativeChance += chance;
                if (random <= cumulativeChance) {
                    selectedRarity = rarity;
                    break;
                }
            }
            
            const filteredCharacters = availableCharacters.filter(char => char.rarity === selectedRarity);
            
            if (filteredCharacters.length === 0) {
                const randomIndex = Math.floor(Math.random() * availableCharacters.length);
                return availableCharacters[randomIndex];
            }
            
            const randomIndex = Math.floor(Math.random() * filteredCharacters.length);
            return filteredCharacters[randomIndex];
        }

        function getRandomTrophyCharacter() {
            const availableTrophyCharacters = gameData.characters.filter(char => 
                char.rarity === "trophy" && 
                !gameData.unlockedCharacters.includes(char.id)
            );
            
            if (availableTrophyCharacters.length === 0) {
                return null;
            }
            
            const randomIndex = Math.floor(Math.random() * availableTrophyCharacters.length);
            return availableTrophyCharacters[randomIndex];
        }

        function resetGame() {
            if (confirm('Вы уверены, что хотите сбросить прогресс игры?')) {
                localStorage.removeItem('appleRebirthGame');
                location.reload();
            }
        }

        window.addEventListener('DOMContentLoaded', initGame);

        console.log('Чтобы сбросить прогресс игры, введите resetGame() в консоли');
        window.resetGame = resetGame;

        window.gameData = gameData;
        window.renderApplePass22Rewards = renderApplePass22Rewards;
    </script>
</body>
</html>